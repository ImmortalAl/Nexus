<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Boundless Chronicles: Eternal truths and timeless stories in the Immortal Nexus sanctuary.">
    <meta name="theme-color" content="#0d0d1a">
    <title>Boundless Chronicles - Immortal Nexus</title>
    
    <!-- Immortal-themed favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="apple-touch-icon" href="../favicon.svg">

    <!-- 1. BASE THEME & CRITICAL STYLES -->
    <link rel="stylesheet" href="../css/base-theme.css?v=1.0">
    <link rel="stylesheet" href="../css/light-theme-immortal.css?v=1.0">
    <link rel="stylesheet" href="../css/mobile-enhanced.css?v=1.0">
    
    <!-- IMMORTAL ENHANCED DESIGN SYSTEM -->
    <link rel="stylesheet" href="css/immortal-enhanced.css?v=1.1">
    <link rel="stylesheet" href="css/mobile-immortal-enhanced.css?v=1.1">
    <link rel="stylesheet" href="css/mobile-ux-enhanced.css?v=1.0">
    
    <!-- Z-INDEX SYSTEM - Centralized layering control -->
    <link rel="stylesheet" href="../css/z-index-system.css?v=1.2">
    <link rel="stylesheet" href="../css/critical.css?v=9.1">

    <!-- 2. EXTERNAL RESOURCES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- 3. CORE GLOBAL STYLES -->
    <link rel="stylesheet" href="../css/styles.css?v=6.3">
    <link rel="stylesheet" href="../css/notifications.css?v=1.0">

    <!-- 4. FEATURES & SHARED COMPONENTS -->
    <link rel="stylesheet" href="../css/features.css?v=8.6">
    <link rel="stylesheet" href="../components/shared/styles.css?v=6.3">

    <!-- 4.5. COMPONENT SYSTEMS -->
    <link rel="stylesheet" href="../css/components/buttons.css?v=1.1">
    <link rel="stylesheet" href="../css/components/spinners.css?v=1.0">
    <link rel="stylesheet" href="../css/unified-modals.css?v=2.0">
    <link rel="stylesheet" href="../css/viewport-optimizations.css?v=1.2">

    <!-- 5. PAGE-SPECIFIC FEATURES -->
    <link rel="stylesheet" href="../components/shared/active-users.css?v=2.1">

    <!-- 6. PAGE-SPECIFIC STYLES -->
    <link rel="stylesheet" href="../css/boundless-chronicles.css?v=4.2">

    <!-- Fonts (lazy loaded) -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Cinzel:wght@400;500;600;700;900&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&family=Playfair+Display:wght@400;700;900&family=Crimson+Pro:wght@400;600;700;900&family=Cormorant+Garamond:wght@400;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Cinzel:wght@400;500;600;700;900&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&family=Playfair+Display:wght@400;700;900&family=Crimson+Pro:wght@400;600;700;900&family=Cormorant+Garamond:wght@400;600;700&display=swap"></noscript>

    <!-- QUILL EDITOR (for rich text chronicle creation) -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css"></noscript>
</head>
<body>
    <!-- Active Users Sidebar, Floating Buttons, and Message Modal will be dynamically injected by shared components -->

    <!-- Floating Theme Toggle Button -->
    <button class="theme-toggle floating-theme-toggle" data-theme-toggle="true" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
    </button>

    <header>
        <!-- SHARED_HEADER -->
    </header>

    <main class="chronicles-main">
        <!-- Newspaper Masthead -->
        <header class="chronicles-header">
            <div class="chronicles-header-content">
                <h1 class="chronicles-title">
                    <span class="title-line-1">The Boundless</span>
                    <span class="title-line-2">Chronicles</span>
                </h1>
                <div class="chronicles-meta">
                    <div class="chronicles-date" id="currentDate"></div>
                    <div class="chronicles-count">Vol. ∞, No. ∞</div>
                </div>
            </div>
        </header>

        <!-- Newspaper Controls -->
        <div class="chronicles-controls">
            <div class="view-controls">
                <button class="view-btn active" data-view="recent" data-sort="submission">
                    Latest News
                </button>
                <button class="view-btn" data-view="chronological" data-sort="event">
                    By Date
                </button>
            </div>

            <button class="submit-chronicle-btn" id="openSubmissionModal">
                <i class="fas fa-pen-nib"></i> Submit Story
            </button>
        </div>

        <!-- Newspaper Columns -->
        <div class="chronicles-container">
            <div id="chroniclesFeed" class="chronicles-feed">
                <div class="loading-chronicles">
                    <div class="chronicle-spinner"></div>
                    <p>Setting the presses...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Chronicle Submission Modal -->
    <div id="submissionModal" class="modal" aria-hidden="true">
        <div class="modal-content chronicle-modal">
            <div class="modal-header">
                <h3><i class="fas fa-newspaper"></i> Submit News Story</h3>
                <button class="close-modal" id="closeSubmissionModal" aria-label="Close modal">×</button>
            </div>

            <form id="submissionForm" class="chronicle-form">
                <div class="form-group">
                    <label for="chronicleTitle">Headline *</label>
                    <input type="text" id="chronicleTitle" name="title" required
                           placeholder="Write a compelling headline">
                </div>

                <div class="form-group">
                    <label for="eventDate">Date of Event *</label>
                    <input type="date" id="eventDate" name="eventDate" required>
                    <small>When did this story take place?</small>
                </div>

                <div class="form-group">
                    <label for="chronicleContent">Story Content *</label>
                    <div id="chronicleEditor" class="quill-editor"></div>
                    <textarea id="chronicleContent" name="content" required style="display: none;"></textarea>
                </div>

                <div class="form-group">
                    <label for="chronicleSources">Sources & Citations</label>
                    <textarea id="chronicleSources" name="sources" rows="4"
                              placeholder="Cite your sources for credibility"></textarea>
                    <small>Build trust with verified information</small>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-newspaper"></i> Publish Story
                    </button>
                    <button type="button" class="btn btn-outline" id="cancelSubmissionModal">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chronicle Edit Modal -->
    <div id="editModal" class="modal" aria-hidden="true">
        <div class="modal-content chronicle-modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Story</h3>
                <button class="close-modal" id="closeEditModal" aria-label="Close modal">×</button>
            </div>
            
            <form id="editForm" class="chronicle-form">
                <input type="hidden" id="editChronicleId" name="chronicleId">

                <div class="form-group">
                    <label for="editTitle">Headline *</label>
                    <input type="text" id="editTitle" name="title" required>
                </div>

                <div class="form-group">
                    <label for="editEventDate">Date of Event *</label>
                    <input type="date" id="editEventDate" name="eventDate" required>
                </div>

                <div class="form-group">
                    <label for="editContent">Story Content *</label>
                    <textarea id="editContent" name="content" required rows="10"></textarea>
                </div>

                <div class="form-group">
                    <label for="editSources">Sources & Citations</label>
                    <textarea id="editSources" name="sources" rows="4"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Story
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteChronicle">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <button type="button" class="btn btn-outline" id="cancelEditModal">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chronicle Detail Modal -->
    <div id="chronicleModal" class="modal" aria-hidden="true">
        <div class="modal-content chronicle-detail-modal">
            <!-- Simple Close Button Header -->
            <div class="chronicle-modal-header">
                <button class="close-modal" id="closeChronicleModal" aria-label="Close modal">×</button>
            </div>

            <article class="chronicle-detail modal-body">
                <!-- Title -->
                <h2 id="modalChronicleTitle" class="chronicle-headline"></h2>

                <!-- Author & Date Meta (below title, newspaper style) -->
                <div class="chronicle-byline">
                    <span class="byline-label">By</span>
                    <div class="chronicle-author-info" id="chronicleAuthorInfo">
                        <!-- Avatar system will populate author display here -->
                    </div>
                    <span class="byline-separator">•</span>
                    <div class="chronicle-dates">
                        <span class="event-date">
                            <i class="fas fa-calendar-alt"></i>
                            <span id="modalEventDate"></span>
                        </span>
                        <span class="byline-separator">•</span>
                        <span class="submission-date">
                            <i class="fas fa-clock"></i>
                            <span id="modalSubmissionDate"></span>
                        </span>
                    </div>
                </div>

                <!-- Voting Buttons (Classic Newspaper Style) -->
                <div class="chronicle-voting-bar">
                    <button class="vote-btn consecrate-btn" id="modalConsecrateBtn" data-action="consecrate" title="Consecrate this chronicle as eternal truth">
                        <i class="fas fa-certificate"></i>
                        <span class="vote-label">Consecrate</span>
                        <span class="vote-count" id="modalConsecrateCount">0</span>
                    </button>
                    <button class="vote-btn investigate-btn" id="modalInvestigateBtn" data-action="investigate" title="Investigate this chronicle for accuracy">
                        <i class="fas fa-search"></i>
                        <span class="vote-label">Investigate</span>
                        <span class="vote-count" id="modalInvestigateCount">0</span>
                    </button>
                </div>

                <!-- Content -->
                <div class="chronicle-content" id="modalChronicleContent"></div>

                <!-- Sources -->
                <div class="chronicle-sources" id="modalChronicleSourcesContainer" style="display: none;">
                    <h4><i class="fas fa-link"></i> Sources & References</h4>
                    <ul id="modalChronicleSourcesList"></ul>
                </div>

                <!-- Contributors (Collaborative Editing) -->
                <div id="chronicleContributors" class="chronicle-contributors" style="display: none;">
                    <!-- Contributors will be populated by JavaScript -->
                </div>

                <!-- Bottom Actions (Edit & Comments) -->
                <div class="chronicle-actions-footer">
                    <button class="action-btn edit-btn" id="modalEditBtn" style="display: none;" title="Edit this chronicle">
                        <i class="fas fa-edit"></i> Edit Story
                    </button>
                    <button class="action-btn comments-btn" id="modalCommentsBtn" title="View reader letters">
                        <i class="fas fa-comments"></i> Reader Letters
                    </button>
                </div>
            </article>

            <!-- Comments Section -->
            <div class="chronicle-comments" id="chronicleCommentsSection">
                <div id="chronicleCommentsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="commentsModal" class="modal" aria-hidden="true">
        <div class="modal-content comments-modal">
            <div class="modal-header">
                <h3 id="commentsModalTitle">Reader Letters</h3>
                <button class="close-modal" id="closeCommentsModal" aria-label="Close modal">×</button>
            </div>
            
            <div class="comments-content">
                <div id="commentsContainer" class="comments-container"></div>
                
                <!-- Comment Input Form -->
                <div class="comment-input-section">
                    <div class="comment-form">
                        <textarea id="newCommentText"
                                  placeholder="Write a letter to the editor..."
                                  rows="3"></textarea>
                        <div class="comment-actions">
                            <button type="button" id="submitCommentBtn" class="btn btn-primary">
                                <i class="fas fa-envelope"></i> Send Letter
                            </button>
                            <div class="character-count">
                                <span id="commentCharCount">0</span>/1000
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Feedback Section -->
            <div id="commentFeedback" class="modal-feedback" style="display: none;"></div>
        </div>
    </div>

    <footer>
        <div class="newspaper-footer">
            <p class="copyright">© Eternal Year ∞ - The Boundless Chronicles</p>
            <p class="motto">Where truth transcends time and mortal limitations</p>
        </div>
    </footer>

    <!-- Shared Component Scripts -->
    <script src="../components/shared/config.js?v=1.4"></script>
    <script src="../js/shared/logger.js?v=1.0"></script>
    <script src="../js/shared/errorBoundary.js?v=1.0"></script>
    
    <!-- Theme Manager - Load early for immediate theme application -->
    <script src="../components/shared/themeManager.js?v=2.2"></script>
    
    <script src="../components/shared/nexus-core.js?v=1.5"></script>
    <script src="../components/shared/authManager.js?v=2.0"></script>
    <script src="../components/shared/apiClient.js?v=2.0"></script>
    <script src="../components/shared/navigation.js?v=2.7"></script>
    <script src="../components/shared/authModal.js?v=4.4"></script>
    <script src="../components/shared/userMenu.js?v=7.4"></script>

    <!-- Avatar System (MUST load before activeUsers.js) -->
    <script src="../js/nexus-avatar-system.js?v=3.2"></script>

    <!-- Unified Voting System -->
    <script src="../js/shared/unifiedVoting.js?v=1.6"></script>

    <!-- Author Identity Card (for voting UI) -->
    <script src="../components/shared/authorIdentityCard.js?v=2.3"></script>

    <script src="../components/shared/activeUsers.js?v=2.3"></script>
    <script src="../components/shared/messageModal.js?v=6.9"></script>

    <!-- Notification System -->
    <script src="../components/shared/notificationManager.js?v=1.1"></script>
    <script src="../components/shared/notificationIcon.js?v=1.2"></script>
    <script src="../components/shared/governanceIndicator.js?v=1.0"></script>

    <!-- Quill Editor -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    
    <!-- Page-specific Scripts -->
    <script src="../js/news/chroniclesFeed.js?v=5.0.debug"></script>
    <script src="../js/news/submissionModal.js?v=2.2"></script>
    <script src="../js/news/commentsSystem.js?v=2.1"></script>
    
    <!-- News Page JavaScript -->
    <script>
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (window.NEXUS && window.NEXUS.initUserMenu) {
                window.NEXUS.initUserMenu();
            }

            if (window.NEXUS && window.NEXUS.initNavigation) {
                window.NEXUS.initNavigation();
            }
            
            // Check if all required components are available
            const requiredComponents = ['ChroniclesFeed', 'SubmissionModal', 'CommentsSystem'];
            const missingComponents = requiredComponents.filter(comp => !window[comp]);
            
            if (missingComponents.length > 0) {
                console.error('Missing required components:', missingComponents);
                return;
            }

            // Initialize all components
            try {
                window.SubmissionModal.init();
                window.CommentsSystem.init();
                window.ChroniclesFeed.init();

                // Ensure chroniclesFeed is properly exposed (compatibility fix)
                if (window.ChroniclesFeed && !window.chroniclesFeed) {
                    window.chroniclesFeed = window.ChroniclesFeed;
                }

                if (window.NEXUSTheme) {
                    window.NEXUSTheme.connectExistingToggles();
                } else if (window.NEXUS && window.NEXUS.initThemeManager) {
                    window.NEXUS.initThemeManager();
                }

                // Initialize Quill editor for chronicle content
                if (typeof Quill !== 'undefined') {
                    const chronicleEditor = new Quill('#chronicleEditor', {
                        theme: 'snow',
                        placeholder: 'Tell the story that shall echo through eternity...',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                ['blockquote', 'code-block'],
                                ['link'],
                                [{ 'align': [] }],
                                ['clean']
                            ]
                        }
                    });

                    // Sync Quill content with hidden textarea for form submission
                    chronicleEditor.on('text-change', function() {
                        const content = chronicleEditor.root.innerHTML;
                        document.getElementById('chronicleContent').value = content;
                    });

                    // Store reference for access in submission modal
                    window.chronicleQuillEditor = chronicleEditor;
                } else {
                    console.warn('Quill editor not available, falling back to textarea');
                }
                
                // Check for chronicle ID to auto-open modal (from front page highlights)
                const urlParams = new URLSearchParams(window.location.search);
                const openChronicleId = urlParams.get('openChronicle');
                if (openChronicleId) {
                    // Clear URL parameter for cleaner experience
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Simple approach: wait a bit then try to open the modal
                    const tryOpenModal = () => {
                        if (window.chroniclesFeed && window.chroniclesFeed.openChronicleModal) {
                            window.chroniclesFeed.openChronicleModal(openChronicleId);
                        } else {
                            setTimeout(tryOpenModal, 1000);
                        }
                    };
                    
                    // Start trying after a short delay
                    setTimeout(tryOpenModal, 2000);
                }
            } catch (error) {
                console.error('Error initializing news page components:', error);
            }

            // Setup Submit Truth button
            const submitTruthBtn = document.getElementById('submitTruthBtn');
            if (submitTruthBtn) {
                submitTruthBtn.addEventListener('click', () => {
                    // Check if user is logged in
                    const token = localStorage.getItem('sessionToken');
                    if (!token) {
                        // Try to open login modal if AuthManager is available
                        if (window.AuthManager && window.AuthManager.openLoginModal) {
                            window.AuthManager.openLoginModal();
                        } else if (window.openSoulModal) {
                            window.openSoulModal('login');
                        } else {
                            alert('Please log in to submit truth');
                        }
                        return;
                    }
                    
                    window.SubmissionModal.open();
                });
            }
        });
    </script>

    <script src="../news-hotfix.js"></script>
    <!-- Mystical Effects -->
    <script src="js/mystical-effects.js?v=1.1"></script>
</body>
</html> 