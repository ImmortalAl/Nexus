<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A timeless sanctuary for liberated spirits to manifest truth and freedom.">
    <meta name="theme-color" content="#0d0d1a">
    <meta property="og:title" content="Immortal Nexus">
    <meta property="og:description" content="An immortal sanctuary for uncensored thought and eternal truth">
    <meta property="og:image" content="https://immortal.nexus/social-cover.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <title>Immortal Nexus</title>
    <!-- Immortal-themed favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.svg">
    <!-- Performance optimized preconnects -->
    <link rel="preconnect" href="https://nexus-ytrg.onrender.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://images.unsplash.com" crossorigin>
    
    <!-- 1. THEME FOUNDATION (MUST BE FIRST) -->
    <link rel="stylesheet" href="css/base-theme.css?v=1.0">
    <link rel="stylesheet" href="css/light-theme-immortal.css?v=1.0">
    <link rel="stylesheet" href="css/mobile-enhanced.css?v=1.0">

    <!-- Z-INDEX SYSTEM - Centralized layering control -->
    <link rel="stylesheet" href="css/z-index-system.css?v=1.2">
    
    <!-- EMERGENCY INLINE DARK THEME - BYPASS CSS LOADING ISSUES -->
    <style>
    body.dark-theme {
        background: #0d0d1a !important;
        color: #f0e6ff !important;
    }

    body.dark-theme header {
        background: linear-gradient(135deg, #1a1b4e, #16213e) !important;
        border-color: #ff5e78 !important;
    }

    /* Remove test colors */
    body.dark-theme .feature-card,
    body.dark-theme .debate-arena,
    body.dark-theme footer {
        background: linear-gradient(to bottom, #101021, #1a1a2e) !important;
        border-color: rgba(255, 94, 120, 0.4) !important;
        color: #f0e6ff !important;
    }

    body.dark-theme nav.main-nav a {
        color: #f0e6ff !important;
    }

    body.dark-theme nav.main-nav a:hover {
        background: rgba(255, 94, 120, 0.2) !important;
    }
    </style>
    
    <!-- 2. CRITICAL CSS - Above-fold essentials loaded synchronously -->
    <link rel="stylesheet" href="css/critical.css?v=7.2">
    
    <!-- 3. GLOBAL STYLES - Site-wide styles loaded synchronously -->
    <link rel="stylesheet" href="css/styles.css?v=10.6">
    
    <!-- 4. PROGRESSIVE LOADING - Non-critical CSS loaded asynchronously -->
    <link rel="preload" href="css/layout.css?v=8.5" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/layout.css?v=8.5"></noscript>
    
    <link rel="preload" href="css/components.css?v=7.2" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/components.css?v=7.2"></noscript>
    
    <link rel="preload" href="css/components/buttons.css?v=1.1" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/components/buttons.css?v=1.1"></noscript>
    
    <link rel="preload" href="css/components/spinners.css?v=1.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/components/spinners.css?v=1.0"></noscript>
    
    <link rel="preload" href="css/features.css?v=7.3" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/features.css?v=7.3"></noscript>
    
    <!-- 5. UNIFIED MODAL SYSTEM -->
    <link rel="preload" href="css/unified-modals.css?v=2.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/unified-modals.css?v=2.0"></noscript>
    
    <!-- 6. SHARED COMPONENTS (lazy loaded) -->
    <link rel="preload" href="components/shared/styles.css?v=15.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="components/shared/styles.css?v=15.0"></noscript>
    
    <!-- 7. PAGE-SPECIFIC (lazy loaded) -->
    <link rel="preload" href="components/shared/active-users.css?v=12.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="components/shared/active-users.css?v=12.0"></noscript>

    <!-- 7.5. VIEWPORT OPTIMIZATIONS (critical for responsive design) -->
    <link rel="stylesheet" href="css/viewport-optimizations.css?v=1.1">
    
    <!-- 8. EXTERNAL RESOURCES (lazy loaded with high priority) -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous"></noscript>
    
    <!-- 9. OPTIMIZED FONTS with fallback -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Lato:wght@300;400;700&family=Cinzel:wght@400;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet';this.onerror=null;" onerror="console.warn('Google Fonts failed to load, using system fonts')">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Lato:wght@300;400;700&family=Cinzel:wght@400;600&display=swap"></noscript>

    <!-- Fallback font definitions for offline/blocked scenarios -->
    <style>
        /* Define font families with comprehensive fallbacks */
        body { font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        .font-cinzel, .nexus-username--mystical { font-family: 'Cinzel', Georgia, 'Times New Roman', serif; }
    </style>
    
    <!-- Inline styles moved to optimized external CSS for better caching and performance -->
    
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
    </style>
</head>
<body>
    <!-- Active Users Sidebar, Floating Buttons, and Message Modal will be dynamically injected by shared components -->

    <header>
        <!-- SHARED_HEADER -->
    </header>

    <main>
        <section class="hero" aria-labelledby="mainHeading">
            <div class="hero-content">
                <h1 id="mainHeading" class="eternal font-immortal-heading text-immortal-glow">Naturally Free Forever</h1>
                <p>Beyond the chains of time and tyranny, we rise as an eternal sanctuary for liberated spirits. Manifest your truth and join a timeless collective unshackled by fleeting powers.</p>
                <div class="hero-buttons">
                    <a href="javascript:void(0)" class="btn btn-primary" id="heroSignupButton">Embrace Immortality</a>
                    <a href="javascript:void(0)" class="btn btn-outline" id="heroLoginButton">Enter The Sanctuary</a>
                </div>
            </div>
        </section>

        <section class="mystical-interlude" role="alert" aria-label="Threshold Warning">
            <div class="interlude-content">
                <div class="warning-symbol">⚡</div>
                <p class="warning-text">WARNING: Immortal thought zone ahead. Here forbidden wisdom flows unfiltered, eternal truths shatter paradigms, and no mortal authority censors consciousness.</p>
            </div>
        </section>

        <section class="features" id="features" aria-labelledby="featuresHeading">
            <div class="section-title">
                <h2 id="featuresHeading" class="font-immortal-heading">Our Timeless Arsenal</h2>
                <p>Instruments of Liberation for Souls Unbound</p>
            </div>
            <div class="features-grid">
                <article class="feature-card" data-feature="souls">
                    <div class="feature-content">
                        <i class="fas fa-user-secret"></i>
                        <h3>Eternal Souls</h3>
                        <p>Connect with kindred spirits in unshackled unity. Whisper truths through timeless channels.</p>
                    </div>
                    <a href="/souls" class="btn btn-primary">Find Souls</a>
                </article>
                <article class="feature-card" data-feature="scrolls">
                    <div class="feature-content">
                        <i class="fas fa-scroll"></i>
                        <h3>Soul Scrolls</h3>
                        <p>Inscribe your essence for eternity. Share thoughts that echo beyond time.</p>
                    </div>
                    <a href="pages/blog.html" class="btn btn-primary">Write Now</a>
                </article>
                <article class="feature-card" data-feature="echoes">
                    <div class="feature-content">
                        <i class="fas fa-comments"></i>
                        <h3>Echoes Unbound</h3>
                        <p>Weave your voice into our eternal tapestry. Discuss freely in a realm without chains.</p>
                    </div>
                    <a href="pages/messageboard.html" class="btn btn-primary">Start Thread</a>
                </article>
                <article class="feature-card" data-feature="chronicles">
                    <div class="feature-content">
                        <i class="fas fa-newspaper"></i>
                        <h3>Boundless Chronicles</h3>
                        <p>Immortalize truths beyond transient lies. Submit stories that endure in collective memory.</p>
                    </div>
                    <a href="pages/news.html" class="btn btn-primary">Explore News</a>
                </article>
                <article class="feature-card" data-feature="debate">
                    <div class="feature-content">
                        <i class="fas fa-gavel"></i>
                        <h3>Clash of Immortals <span style="color: #FFA500; font-size: 0.8em; font-weight: normal;">(Under Development)</span></h3>
                        <p>Engage in discourse unbound by mortal limits. Let truth reign in the eternal arena.</p>
                    </div>
                    <a href="pages/debate.html" class="btn btn-primary">Enter Arena</a>
                </article>
                <article class="feature-card" data-feature="nexus">
                    <div class="feature-content">
                        <i class="fas fa-project-diagram"></i>
                        <h3>Infinite Nexus</h3>
                        <p>Link your spirit to our living web spanning beyond time. Contribute to the eternal mindmap.</p>
                    </div>
                    <a href="pages/mindmap.html" class="btn btn-primary">Join the Map</a>
                </article>
                <article class="feature-card" data-feature="vault">
                    <div class="feature-content">
                        <i class="fas fa-vault"></i>
                        <h3>Timeless Vault <span style="color: #FFA500; font-size: 0.8em; font-weight: normal;">(Under Development)</span></h3>
                        <p>Safeguard visions in an archive immune to erasure. Upload and preserve infinite wisdom.</p>
                    </div>
                    <a href="pages/archive.html" class="btn btn-primary">Access Vault</a>
                </article>
                <article class="feature-card" data-feature="commons">
                    <div class="feature-content">
                        <i class="fas fa-comment-dots"></i>
                        <h3>Celestial Commons</h3>
                        <p>Converse in real-time with immortal souls. Join our sacred chatroom where dialogue flows freely.</p>
                    </div>
                    <a href="pages/celestial-commons.html" class="btn btn-primary">Join Chat</a>
                </article>
            </div>
        </section>

        <section class="highlights eternal-souls-highlight" id="profiles" aria-labelledby="profilesHeading">
            <div class="section-title">
                <h2 id="profilesHeading" class="font-immortal-mystical text-immortal-gradient">
                    Eternal Souls Highlight
                </h2>
                <p>Connect with our community pillars and featured souls</p>
            </div>
            
            <div class="highlight-grid souls-highlight-container">
                <!-- ImmortalAl Featured Card -->
                <div class="highlight-item soul-highlight-card soul-card-founder">
                    <div class="soul-card-content">
                        <div id="founder-soul-display" class="soul-display-container">
                            <!-- Immortal Nexus Avatar System will populate this -->
                        </div>
                        <div class="soul-card-actions">
                            <button class="btn btn-primary soul-message-btn" onclick="openFounderMessage()" aria-label="Send message to ImmortalAl">
                                <i class="fas fa-envelope"></i> Message
                            </button>
                            <a href="/souls/profile.html?username=ImmortalAl" class="btn btn-outline soul-profile-btn" aria-label="View ImmortalAl's profile">
                                <i class="fas fa-user"></i> View Profile
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Featured Community Soul -->
                <div class="highlight-item soul-highlight-card soul-card-featured">
                    <div class="soul-card-content">
                        <div id="featured-soul-display" class="soul-display-container">
                            <div class="loading-soul">
                                <div class="soul-loading-spinner"></div>
                                <p>Summoning featured soul...</p>
                            </div>
                        </div>
                        <div class="soul-card-actions" id="featured-soul-actions" style="display: none;">
                            <button class="btn btn-primary soul-message-btn" onclick="openFeaturedSoulMessage()" aria-label="Send message to featured soul">
                                <i class="fas fa-envelope"></i> Message
                            </button>
                            <a href="#" id="featured-soul-profile-link" class="btn btn-outline soul-profile-btn" aria-label="View featured soul's profile">
                                <i class="fas fa-user"></i> View Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section-footer">
                <a href="/souls" class="btn btn-primary">Explore Souls</a>
            </div>
        </section>

        <section class="highlights" id="blog" aria-labelledby="blogHeading">
            <div class="section-title">
                <h2 id="blogHeading" class="font-immortal-mystical text-immortal-gradient">Soul Scrolls</h2>
                <p>Featured Reflections from Liberated Spirits</p>
            </div>
            <div class="dual-highlight-grid" id="scrollsHighlights">
                <!-- Editorial Choice Card -->
                <div class="highlight-card editorial-choice-card">
                    <div class="card-header">
                        <h3><i class="fas fa-star"></i> Editorial Choice</h3>
                        <p>Curator's selection of timeless wisdom</p>
                    </div>
                    <div class="card-content" id="editorialScrollsContent">
                        <div class="highlight-item loading">
                            <h4>Loading Editorial Selection...</h4>
                            <p>Gathering curated excellence...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Posts Card -->
                <div class="highlight-card recent-posts-card">
                    <div class="card-header">
                        <h3><i class="fas fa-clock"></i> Recent Posts</h3>
                        <p>Latest whispers from eternal minds</p>
                    </div>
                    <div class="card-content" id="recentScrollsContent">
                        <div class="highlight-item loading">
                            <h4>Loading Recent Scrolls...</h4>
                            <p>Gathering the latest reflections...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section-footer">
                <a href="pages/blog.html" class="btn btn-primary">Read Scrolls</a>
            </div>
        </section>

        <section class="highlights echoes-unbound-agora" id="messageboard" aria-labelledby="messageboardHeading">
            <div class="section-title">
                <h2 id="messageboardHeading" class="font-immortal-mystical text-immortal-gradient">Echoes Unbound</h2>
                <p class="agora-subtitle">
                    Hot Threads from the Eternal Tapestry
                </p>
            </div>
            <div class="highlight-grid" id="echoesHighlights">
                <!-- Dynamic content will load here -->
                <div class="highlight-item">
                    <h4>Loading Echoes...</h4>
                    <p>Gathering the latest threads from eternal minds...</p>
                    <p class="author">— System</p>
                </div>
            </div>
            
            <div class="agora-preview">
                <div class="agora-info">
                    <p>Future home of the <strong>Anonymous Agora</strong> - eternal marketplace of ideas</p>
                </div>
            </div>
        </section>

        <section class="highlights" id="news" aria-labelledby="newsHeading">
            <div class="section-title">
                <h2 id="newsHeading" class="text-immortal-gradient">Boundless Chronicles</h2>
                <p>Featured Stories from the Eternal Chronicles</p>
            </div>
            <div class="highlight-grid" id="chroniclesHighlights">
                <!-- Dynamic content will load here -->
                <div class="highlight-item">
                    <h4>Loading Chronicles...</h4>
                    <p>Fetching the latest stories from the eternal archives...</p>
                    <p class="author">— System</p>
                </div>
            </div>
        </section>

        <section class="highlights debate-arena" id="debate" aria-labelledby="debateHeading">
            <div class="section-title">
                <h2 id="debateHeading" class="font-immortal-mystical text-immortal-gradient">Clash of Immortals <span style="color: #FFA500; font-size: 0.7em; font-weight: normal; display: block; margin-top: 5px;">(Under Development)</span></h2>
                <p>Where Eternal Minds Forge Truth</p>
            </div>
            <h3 class="debate-topic">Resolved: Freedom is an Eternal Right</h3>
            <p>Join the timeless struggle as liberated souls contest existence.</p>
            <div class="debate-preview">
                <div class="debate-position">
                    <h4>Affirmative</h4>
                    <p><strong>"Freedom transcends time;</strong> it's woven into existence." — ImmortalAl</p>
                    <div class="debate-actions">
                        <button class="btn btn-outline" aria-label="Vote yes for immortal freedom">Vote Yes</button>
                        <span class="vote-count">12 Votes</span>
                    </div>
                </div>
                <div class="debate-position">
                    <h4>Negative</h4>
                    <p><strong>"Freedom is a fleeting illusion,</strong> bound by power." — EternalVoice</p>
                    <div class="debate-actions">
                        <button class="btn btn-outline" aria-label="Vote no for immortal freedom">Vote No</button>
                        <span class="vote-count">8 Votes</span>
                    </div>
                </div>
            </div>
            <div class="section-footer">
                <a href="pages/debate.html" class="btn btn-primary">Enter Clash</a>
            </div>
        </section>

        <section class="highlights mindmap-section" id="mindmap" aria-labelledby="mindmapHeading">
            <div class="section-title">
                <h2 id="mindmapHeading" class="font-immortal-mystical text-immortal-gradient">Infinite Nexus</h2>
                <p>Our Living Web Binds the Unbound</p>
            </div>
            
            <!-- Interactive Preview Controls -->
            <div class="mindmap-preview-controls">
                <div class="mindmap-search-container">
                    <input type="text" id="mindmapPreviewSearch" placeholder="Search the Nexus..." 
                           class="mindmap-search-input" />
                    <button id="mindmapPreviewSearchBtn" class="mindmap-search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mindmap-stats" id="mindmapStats">
                    <span class="loading-stats">Loading stats...</span>
                </div>
            </div>
            
            <!-- Interactive Preview Container -->
            <div class="mindmap-preview interactive" id="mindmapPreview">
                <div class="mindmap-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading Nexus preview...</p>
                </div>
                
                <!-- Nodes will be populated by JavaScript -->
                <div id="mindmapPreviewNodes" class="mindmap-preview-nodes"></div>
                
                <!-- Connections will be drawn by JavaScript -->
                <svg id="mindmapPreviewConnections" class="mindmap-preview-connections">
                    <!-- SVG lines will be drawn here -->
                </svg>
            </div>
            
            <!-- Node Details Tooltip -->
            <div id="mindmapPreviewTooltip" class="mindmap-preview-tooltip">
                <div class="tooltip-header">
                    <h4 class="tooltip-title"></h4>
                    <span class="tooltip-score"></span>
                </div>
                <div class="tooltip-content"></div>
                <div class="tooltip-meta">
                    <span class="tooltip-creator"></span>
                    <span class="tooltip-connections"></span>
                </div>
                <div class="tooltip-actions">
                    <button class="btn btn-sm btn-primary" id="exploreNodeBtn">Explore Node</button>
                </div>
            </div>
            
            <div class="section-footer">
                <a href="pages/mindmap.html" class="btn btn-primary">Join Full Nexus</a>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-links-grid">
                <div class="footer-column">
                    <h3>Eternal Links</h3>
                    <ul>
                        <li><a href="pages/about.html">About Our Eternity</a></li>
                        <li><a href="pages/faq.html">Immortal Questions</a></li>
                        <li><a href="pages/contact.html">Contact the Beyond</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Community</h3>
                    <ul>
                        <li><a href="pages/guidelines.html">Sanctuary Guidelines</a></li>
                        <li><a href="pages/privacy.html">Eternal Privacy</a></li>
                        <li><a href="pages/terms.html">Terms of Infinity</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Stay Connected</h3>
                    <div class="social-links">
                        <a href="#" aria-label="Twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Discord" title="Discord"><i class="fab fa-discord"></i></a>
                        <a href="#" aria-label="Telegram" title="Telegram"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
            </div>
            
            <div class="footer-feedback-section">
                <button type="button" class="feedback-btn footer" id="feedbackBtnFooter" aria-label="Open feedback form">
                    <i class="fas fa-heart"></i> Share Your Eternal Feedback
                </button>
            </div>
            
            <hr class="footer-divider">
            
            <div class="footer-bottom">
                <p>&copy; 2025 Immortal Nexus. All eternal rights reserved.</p>
                <p>Embrace your infinite potential and connect across eternity.</p>
            </div>
        </div>
    </footer>

    <!-- Feedback Modal (hidden by default) -->
    <div id="feedbackModal" class="modal" aria-hidden="true">
      <form id="feedbackForm" class="feedback-modal" autocomplete="off" tabindex="-1" role="dialog" aria-labelledby="feedbackTitle">
        <button type="button" class="close-modal" id="closeFeedbackModal" aria-label="Close Feedback Modal"><i class="fas fa-times"></i></button>
        <h3 id="feedbackTitle"><i class="fas fa-infinity"></i> Eternal Feedback</h3>
        <div class="feedback-subtitle">Your thoughts help shape our immortal sanctuary. Share freely—anonymity is honored.</div>
        <div class="form-group">
          <label for="feedbackContent" class="visually-hidden">Feedback content</label>
          <textarea id="feedbackContent" placeholder="Share your eternal thoughts..." maxlength="1000" required></textarea>
        </div>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="feedbackAnonymous">
            <span class="checkmark"></span>
            Send as <span style="font-style:italic;">Anonymous Soul</span>
          </label>
        </div>
        <div class="form-group" id="anonymousNameGroup" style="display:none;">
          <label for="feedbackAnonymousName">Name (optional)</label>
          <input type="text" id="feedbackAnonymousName" placeholder="How should we address you?" maxlength="50">
        </div>
        <div id="feedbackUserInfo" class="user-info-display" style="display:none;">
          <span id="feedbackUsername"></span>
        </div>
        <div class="modal-actions">
          <button type="submit" id="submitFeedback" class="btn btn-primary" aria-label="Submit feedback"><i class="fas fa-paper-plane"></i> Send Feedback</button>
          <button type="button" id="cancelFeedback" class="btn btn-outline" aria-label="Cancel feedback">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Config MUST be loaded first -->
    <script src="components/shared/config.js?v=2.0"></script>
    <script src="js/shared/logger.js?v=1.0"></script>
    <script src="js/shared/errorBoundary.js?v=1.0"></script>
    
    <!-- Theme Manager - Load early for immediate theme application -->
    <script src="components/shared/themeManager.js?v=2.2"></script>

    <!-- Core Immortal Nexus Components -->
    <script src="components/shared/nexus-core.js?v=1.5"></script>
    <script src="components/shared/authManager.js?v=1.4"></script>
    <script src="components/shared/authModal.js?v=4.2"></script>
    <script src="components/shared/apiClient.js?v=1.5"></script>
    <script src="components/shared/navigation.js?v=2.3"></script>
    <script src="components/shared/userMenu.js?v=7.2"></script>

    <!-- Avatar System (MUST load before activeUsers.js) -->
    <script src="js/nexus-avatar-system.js?v=3.1"></script>
    
    <!-- Unified Voting System -->
    <script src="js/shared/unifiedVoting.js?v=1.6"></script>

    <!-- Active Users (depends on nexus-avatar-system.js) -->
    <script src="components/shared/activeUsers.js?v=2.3"></script>
    <script src="components/shared/messageModal.js?v=1.6"></script>
    <script src="js/main.js?v=3.6"></script>
    <script src="js/mindmap-preview.js?v=1.5"></script>
    
    <!-- Optimized Hero Particles - Hardware Accelerated -->
    <script src="js/particleSystem.js?v=1.0"></script>
    
    <!-- Hero Button Handlers -->
    <script src="js/heroButtons.js?v=1.0"></script>
    
    <script>
    // Dynamic Chronicles Highlights
    async function loadChroniclesHighlights() {
        try {
            // Wait for NexusAvatars to be available
            if (!window.NexusAvatars) {
                setTimeout(loadChroniclesHighlights, 200);
                return;
            }

            // Fetch chronicles data with error handling
            let response = await fetch(`${window.NEXUS_CONFIG.API_BASE_URL}/chronicles?limit=2&sort=createdAt`, {
                signal: AbortSignal.timeout(10000) // 10 second timeout
            }).catch(err => {
                console.warn('[Chronicles] Network error, API may be offline:', err.message);
                return null;
            });

            if (!response) {
                // Show offline message but keep existing content
                console.warn('[Chronicles] Using fallback content');
                return;
            }

            if (!response.ok) {
                console.warn(`[Chronicles] HTTP ${response.status}, using fallback content`);
                return;
            }

            const data = await response.json();
            const chronicles = Array.isArray(data) ? data : (data.docs || data.data || []);
            
            if (!Array.isArray(chronicles)) {
                console.error('Chronicles data is not an array:', data);
                return;
            }
            
            const highlightsContainer = document.getElementById('chroniclesHighlights');
            if (!highlightsContainer || chronicles.length === 0) return;
            
            // Clear existing content and build with unified avatar system
            highlightsContainer.innerHTML = '';
            
            chronicles.forEach(post => {
                const date = new Date(post.eventDate || post.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                const author = post.author || {};
                
                // Create highlight card container
                const highlightCard = document.createElement('a');
                highlightCard.href = `pages/news.html?openChronicle=${post._id}`;
                highlightCard.className = 'highlight-item chronicle-highlight-card chronicle-link';
                highlightCard.setAttribute('data-chronicle-id', post._id);
                
                // Add click handler to open specific chronicle modal
                highlightCard.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = `pages/news.html?openChronicle=${post._id}`;
                });
                
                // Create title
                const title = document.createElement('h4');
                title.className = 'chronicle-title-prominent';
                title.textContent = post.title;
                
                // Create excerpt - strip HTML tags first
                const excerpt = document.createElement('p');
                excerpt.className = 'chronicle-excerpt';
                const textOnly = post.content.replace(/<[^>]*>/g, '').trim();
                excerpt.textContent = (textOnly.length > 120 ? textOnly.substring(0, 120) + '...' : textOnly);
                
                // Create unified user display
                const userDisplay = window.NexusAvatars.createUserDisplay({
                    username: author.username || 'Anonymous',
                    title: 'Eternal Chronicler',
                    avatarSize: 'sm',
                    displaySize: 'sm',
                    compact: true,
                    mystical: author.isVIP || author.role === 'admin',
                    online: author.online,
                    customAvatar: author.avatar,
                    usernameStyle: 'immortal',
                    enableUnifiedNavigation: true
                });
                
                // Create meta section
                const metaDiv = document.createElement('div');
                metaDiv.className = 'highlight-meta';
                metaDiv.innerHTML = `
                    <span class="date">${date}</span>
                    <span class="read-more-indicator">Read full story →</span>
                `;
                
                // Assemble highlight card
                highlightCard.appendChild(title);
                highlightCard.appendChild(excerpt);
                highlightCard.appendChild(userDisplay);
                highlightCard.appendChild(metaDiv);
                
                highlightsContainer.appendChild(highlightCard);
            });
            
            // Add "Read More Stories" button in section-footer
            const parentSection = highlightsContainer.closest('section');
            let sectionFooter = parentSection.querySelector('.section-footer');
            if (!sectionFooter) {
                sectionFooter = document.createElement('div');
                sectionFooter.className = 'section-footer';
                parentSection.appendChild(sectionFooter);
            }
            const readMoreBtn = document.createElement('a');
            readMoreBtn.href = 'pages/news.html';
            readMoreBtn.className = 'btn btn-primary';
            readMoreBtn.textContent = 'Read More Stories';
            sectionFooter.appendChild(readMoreBtn);
            
        } catch (error) {
            console.warn('[Chronicles] Error loading highlights:', error.message);
            // Keep fallback content in DOM
        }
    }
    
    // Load on page ready
    document.addEventListener('DOMContentLoaded', loadChroniclesHighlights);
    </script>
    
    <script>
    // Dynamic Soul Scrolls Highlights
    async function loadScrollsHighlights() {
        try {
            // Wait for NexusAvatars to be available
            if (!window.NexusAvatars) {
                setTimeout(loadScrollsHighlights, 200);
                return;
            }
            
            // Load both recent posts and editorial highlights in parallel
            const [recentResponse, highlightsResponse] = await Promise.all([
                fetch(`${window.NEXUS_CONFIG.API_BASE_URL}/blogs?limit=1&sort=createdAt`),
                fetch(`${window.NEXUS_CONFIG.API_BASE_URL}/highlights/soul_scrolls`)
            ]);
            
            // Load recent posts
            if (recentResponse.ok) {
                const recentData = await recentResponse.json();
                const recentScrolls = recentData.docs || recentData;
                loadRecentScrolls(recentScrolls.slice(0, 1));
            }
            
            // Load editorial highlights
            if (highlightsResponse.ok) {
                const highlightsData = await highlightsResponse.json();
                loadEditorialHighlights(highlightsData.highlights || []);
            }
            
        } catch (error) {
            console.error('Failed to load Soul Scrolls highlights:', error);
            // Keep fallback content in DOM
        }
    }
    
    function loadRecentScrolls(scrolls) {
        const container = document.getElementById('recentScrollsContent');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (scrolls.length === 0) {
            container.innerHTML = '<div class="highlight-item empty"><p>No recent scrolls available</p></div>';
            return;
        }
        
        scrolls.forEach(scroll => {
            const highlightCard = createScrollHighlightCard(scroll, 'recent');
            container.appendChild(highlightCard);
        });
    }
    
    function loadEditorialHighlights(highlights) {
        const container = document.getElementById('editorialScrollsContent');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Find admin (editorial) highlight for soul-scrolls section
        const editorialHighlight = highlights.find(h => h.type === 'admin');
        
        if (!editorialHighlight) {
            container.innerHTML = `
                <div class="highlight-item empty">
                    <p>No editorial selection available</p>
                    <small>The immortal curators are reviewing timeless wisdom...</small>
                </div>
            `;
            return;
        }
        
        const highlightCard = createScrollHighlightCard(editorialHighlight.content, 'editorial');
        container.appendChild(highlightCard);
    }
    
    function createScrollHighlightCard(scroll, cardType) {
        const date = new Date(scroll.createdAt).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        });
        const author = scroll.author || {};
        
        // Create highlight card container with click navigation
        const highlightCard = document.createElement('a');
        highlightCard.href = 'pages/blog.html';
        highlightCard.className = `highlight-item scroll-highlight-card ${cardType}-highlight`;
        highlightCard.setAttribute('data-scroll-id', scroll._id || scroll.id);
        
        // Add click handler to open specific scroll
        highlightCard.addEventListener('click', function(e) {
            e.preventDefault();
            sessionStorage.setItem('openScrollId', scroll._id || scroll.id);
            window.location.href = 'pages/blog.html';
        });
        
        // Create title
        const title = document.createElement('h4');
        title.className = 'scroll-title-prominent';
        title.textContent = scroll.title;
        
        // Create excerpt (strip HTML and limit length)
        const excerpt = document.createElement('p');
        excerpt.className = 'scroll-excerpt';
        const textContent = (scroll.content || scroll.excerpt || '').replace(/<[^>]*>/g, '');
        excerpt.textContent = textContent.length > 100 ? textContent.substring(0, 100) + '...' : textContent;
        
        // Create unified user display
        const userDisplay = window.NexusAvatars.createUserDisplay({
            username: author.username || 'Anonymous',
            title: cardType === 'editorial' ? 'Featured Scroll Weaver' : 'Scroll Weaver',
            avatarSize: 'sm',
            displaySize: 'sm',
            compact: true,
            mystical: author.isVIP || author.role === 'admin' || cardType === 'editorial',
            online: author.online,
            customAvatar: author.avatar,
            usernameStyle: 'immortal',
            enableUnifiedNavigation: true
        });
        
        // Create meta section
        const metaDiv = document.createElement('div');
        metaDiv.className = 'highlight-meta';
        const metaContent = `
            <span class="date">${date}</span>
            <span class="read-more-indicator">Read full scroll →</span>
        `;
        metaDiv.innerHTML = metaContent;
        
        // Assemble highlight card
        highlightCard.appendChild(title);
        highlightCard.appendChild(excerpt);
        highlightCard.appendChild(userDisplay);
        highlightCard.appendChild(metaDiv);
        
        return highlightCard;
    }
    
    // Load on page ready
    document.addEventListener('DOMContentLoaded', loadScrollsHighlights);
    </script>
    
    <script>
    // Curated thread selection algorithm
    function selectCuratedThreads(threads, count = 2) {
        if (!threads || threads.length === 0) return [];

        // Score each thread based on multiple factors
        const scoredThreads = threads.map(thread => {
            let score = 0;

            // Vote score factor (higher weight for popular threads)
            const voteScore = thread.voteScore || 0;
            score += voteScore * 10; // Each vote point = 10 score points

            // Engagement factor (replies indicate active discussion)
            const replyCount = thread.replies ? thread.replies.length : 0;
            score += replyCount * 5; // Each reply = 5 score points

            // Content quality factor (longer content generally better)
            const contentLength = thread.content ? thread.content.length : 0;
            if (contentLength > 100) score += 15; // Bonus for substantial content
            if (contentLength > 300) score += 10; // Extra bonus for detailed content

            // Recency factor (prefer recent but not only newest)
            const hoursOld = (Date.now() - new Date(thread.createdAt).getTime()) / (1000 * 60 * 60);
            if (hoursOld < 24) score += 20; // Recent bonus
            else if (hoursOld < 72) score += 10; // Semi-recent bonus
            else if (hoursOld > 168) score -= 5; // Slight penalty for very old

            // Title quality factor (avoid very short titles)
            if (thread.title && thread.title.length > 20) score += 5;

            return { ...thread, curatedScore: score };
        });

        // Sort by score (descending) and select top threads
        scoredThreads.sort((a, b) => b.curatedScore - a.curatedScore);

        // Ensure author diversity - avoid showing multiple threads from same user
        const selectedThreads = [];
        const usedAuthors = new Set();

        for (const thread of scoredThreads) {
            if (selectedThreads.length >= count) break;

            const authorId = thread.author?._id || thread.author?.id || 'anonymous';

            // If we haven't used this author yet, or we're running low on options
            if (!usedAuthors.has(authorId) || selectedThreads.length < count && scoredThreads.length - selectedThreads.length <= count - selectedThreads.length) {
                selectedThreads.push(thread);
                usedAuthors.add(authorId);
            }
        }

        // If we still need more threads, fill with highest scoring remaining
        while (selectedThreads.length < count && selectedThreads.length < scoredThreads.length) {
            for (const thread of scoredThreads) {
                if (selectedThreads.length >= count) break;
                if (!selectedThreads.find(t => t._id === thread._id)) {
                    selectedThreads.push(thread);
                }
            }
        }

        return selectedThreads.slice(0, count);
    }

    // Dynamic Echoes Unbound Highlights
    async function loadEchoesHighlights() {
        try {
            // Wait for NexusAvatars to be available
            if (!window.NexusAvatars) {
                setTimeout(loadEchoesHighlights, 200);
                return;
            }

            // Fetch more threads for better curation selection with error handling
            const response = await fetch(`${window.NEXUS_CONFIG.API_BASE_URL}/threads?limit=10`, {
                signal: AbortSignal.timeout(10000) // 10 second timeout
            }).catch(err => {
                console.warn('[Echoes] Network error, API may be offline:', err.message);
                return null;
            });

            if (!response) {
                // Show offline message
                const highlightsContainer = document.getElementById('echoesHighlights');
                if (highlightsContainer) {
                    highlightsContainer.innerHTML = '<div class="highlight-item"><h4>Echoes Temporarily Unavailable</h4><p>The eternal tapestry is being rewoven...</p></div>';
                }
                return;
            }

            if (!response.ok) {
                console.warn(`[Echoes] HTTP ${response.status}`);
                return;
            }

            const data = await response.json();
            let allThreads = Array.isArray(data) ? data : (data.threads || data.docs || data.data || []);

            // Curated selection algorithm
            const messages = selectCuratedThreads(allThreads, 2);
            
            if (!Array.isArray(messages)) {
                console.error('Threads data is not an array:', data);
                return;
            }
            
            const highlightsContainer = document.getElementById('echoesHighlights');
            if (!highlightsContainer) {
                console.error('Echoes highlights container not found');
                return;
            }
            if (messages.length === 0) {
                highlightsContainer.innerHTML = '<div class="highlight-item"><h4>No Echoes Available</h4><p>No threads found in the eternal tapestry...</p></div>';
                return;
            }
            
            // Clear existing content and build with unified avatar system
            highlightsContainer.innerHTML = '';
            
            messages.forEach(message => {
                const date = new Date(message.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                // Handle anonymous vs regular authors
                let author;
                if (message.isAnonymous) {
                    author = {
                        username: message.anonymousDisplayName || 'Anonymous Seeker',
                        displayName: message.anonymousDisplayName || 'Anonymous Seeker',
                        avatar: null,
                        isAnonymous: true
                    };
                } else {
                    author = message.author || {};
                }
                const replyCount = message.replies ? message.replies.length : 0;

                // Create highlight card container
                const highlightCard = document.createElement('a');
                highlightCard.href = 'pages/messageboard.html';
                highlightCard.className = `highlight-item echo-highlight-card echo-link${author.isAnonymous ? ' anonymous-thread' : ''}`;
                highlightCard.setAttribute('data-message-id', message._id);
                
                // Add click handler to open specific thread
                highlightCard.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = `pages/messageboard.html?openThread=${message._id}`;
                });
                
                // Create content
                const title = document.createElement('h3');
                title.className = 'echo-title-prominent';
                title.textContent = message.title || 'Untitled Echo';
                
                const content = document.createElement('p');
                content.className = 'echo-content';
                // Handle HTML content properly
                const textContent = message.content ? 
                    message.content.replace(/<[^>]*>/g, '') : 'No content';
                content.textContent = textContent;
                
                // Create user display with avatar using unified avatar system
                const userDisplay = window.NexusAvatars.createUserDisplay({
                    username: author.username,
                    title: author.isAnonymous ? 'Anonymous Echo' : (author.displayName || 'Echo Weaver'),
                    avatarSize: 'sm',
                    displaySize: 'sm',
                    compact: true,
                    mystical: (!author.isAnonymous) && (author.isVIP || author.role === 'admin'),
                    online: author.online,
                    customAvatar: author.isAnonymous ? null : author.avatar,
                    usernameStyle: author.isAnonymous ? 'anonymous' : 'immortal',
                    enableUnifiedNavigation: !author.isAnonymous, // Don't enable navigation for anonymous
                    anonymous: author.isAnonymous
                });
                
                // Create meta info
                const metaDiv = document.createElement('div');
                metaDiv.className = 'echo-meta';
                metaDiv.innerHTML = `
                    <span class="echo-date">${date}</span>
                    <span class="echo-replies">${replyCount} replies</span>
                `;
                
                // Create minimalist voting row
                const votingRow = document.createElement('div');
                votingRow.className = 'minimal-vote-row';
                votingRow.innerHTML = `
                    <button class="minimal-vote-btn upvote-btn ${message.userVote === 'upvote' ? 'active' : ''}"
                            data-thread-id="${message._id}" data-vote="upvote">
                        <i class="fas fa-arrow-up"></i>
                        <span>${message.upvotes || 0}</span>
                    </button>
                    <button class="minimal-vote-btn challenge-btn ${message.userVote === 'challenge' ? 'active' : ''}"
                            data-thread-id="${message._id}" data-vote="challenge">
                        <i class="fas fa-shield-alt"></i>
                        <span>${message.challenges || 0}</span>
                    </button>
                `;

                // Add event listeners to voting buttons
                votingRow.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const btn = e.target.closest('.minimal-vote-btn');
                    if (btn && window.unifiedVoting) {
                        const voteType = btn.dataset.vote;
                        const threadId = btn.dataset.threadId;
                        window.unifiedVoting.vote('echo', threadId, voteType);

                        // Update UI
                        if (voteType === 'upvote') {
                            btn.classList.toggle('active');
                            votingRow.querySelector('.challenge-btn').classList.remove('active');
                        } else if (voteType === 'challenge') {
                            // Open challenge modal if not already active
                            if (!btn.classList.contains('active') && window.unifiedVoting.openChallengeModal) {
                                window.unifiedVoting.openChallengeModal(threadId);
                            } else {
                                btn.classList.toggle('active');
                                votingRow.querySelector('.upvote-btn').classList.remove('active');
                            }
                        }
                    }
                });

                // Assemble card
                highlightCard.appendChild(title);
                highlightCard.appendChild(content);
                highlightCard.appendChild(userDisplay);
                highlightCard.appendChild(metaDiv);
                highlightCard.appendChild(votingRow);

                highlightsContainer.appendChild(highlightCard);
            });

        } catch (error) {
            console.warn('[Echoes] Error loading highlights:', error.message);
            const highlightsContainer = document.getElementById('echoesHighlights');
            if (highlightsContainer) {
                highlightsContainer.innerHTML = '<div class="highlight-item"><h4>Echoes Temporarily Unavailable</h4><p>The eternal tapestry is being rewoven...</p></div>';
            }
        }
    }
    
    // Load echoes on page ready
    document.addEventListener('DOMContentLoaded', loadEchoesHighlights);
    </script>
    
    <!-- Error Tracking System (loads first for maximum coverage) -->
    <script src="js/error-tracker.js?v=1.1"></script>

    <!-- Analytics Tracking System -->
    <script src="js/analytics-tracker.js?v=2.1" async></script>
    
</body>
</html>