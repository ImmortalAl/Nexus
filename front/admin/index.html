<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="Eternal Dominion - Administrative control center for Immortal Nexus">
    <meta name="theme-color" content="#0d0d1a">
    <title>Immortal's Sanctum - Immortal Nexus Admin</title>
    <!-- Immortal-themed favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="apple-touch-icon" href="../favicon.svg">
    <!-- 1. THEME FOUNDATION (MUST BE FIRST) -->
    <link rel="stylesheet" href="../css/base-theme.css?v=1.0">
    
    <!-- Z-INDEX SYSTEM - Centralized layering control -->
    <link rel="stylesheet" href="../css/z-index-system.css?v=1.1">
    
    <!-- 2. CRITICAL CSS - Above-fold essentials loaded synchronously -->
    <link rel="stylesheet" href="../css/critical.css?v=7.2">
    
    <!-- 3. GLOBAL STYLES - Site-wide styles loaded synchronously -->
    <link rel="stylesheet" href="../css/styles.css?v=7.1">
    
    <!-- 4. PROGRESSIVE LOADING - Non-critical CSS loaded asynchronously -->
    <link rel="preload" href="../css/layout.css?v=8.2" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/layout.css?v=8.2"></noscript>
    
    <link rel="preload" href="../css/components.css?v=7.2" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/components.css?v=7.2"></noscript>
    
    <link rel="preload" href="../css/features.css?v=7.7" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/features.css?v=7.7"></noscript>
    
    <!-- 5. SHARED COMPONENTS (lazy loaded) -->
    <link rel="preload" href="../components/shared/styles.css?v=7.1" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../components/shared/styles.css?v=7.1"></noscript>
    
    <!-- 5.5. UNIFIED MODAL SYSTEM -->
    <link rel="preload" href="../css/unified-modals.css?v=2.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/unified-modals.css?v=2.0"></noscript>
    
    <!-- 5.6. UNIFIED BUTTON SYSTEM -->
    <link rel="preload" href="../css/components/buttons.css?v=1.1" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/components/buttons.css?v=1.1"></noscript>

    <link rel="preload" href="../css/components/spinners.css?v=1.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/components/spinners.css?v=1.0"></noscript>

    <!-- 5.7. VIEWPORT OPTIMIZATIONS -->
    <link rel="stylesheet" href="../css/viewport-optimizations.css?v=1.2">

    <!-- 6. PAGE-SPECIFIC (lazy loaded) -->
    <link rel="preload" href="../components/shared/active-users.css?v=2.1" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../components/shared/active-users.css?v=2.1"></noscript>
    
    <link rel="preload" href="../css/admin.css?v=6.6" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="../css/admin.css?v=6.6"></noscript>
    
    <!-- 7. EXTERNAL RESOURCES (lazy loaded) -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer"></noscript>
</head>
<body>
    
    <!-- Site Navigation Header (like other pages) -->
    <header>
        <!-- SHARED_HEADER -->
    </header>

    <!-- Admin Panel Header (admin tabs) -->
    <header class="admin-header">
        <div class="admin-logo">
            <i class="fas fa-crown"></i>
            <span>Immortal's Sanctum</span>
        </div>
        <nav class="admin-nav">
            <ul>
                <li><a href="#dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#users"><i class="fas fa-users"></i> Soul Management</a></li>
                <li><a href="#curation"><i class="fas fa-star"></i> Content Curation</a></li>
                <li><a href="#analytics"><i class="fas fa-chart-bar"></i> Eternal Analytics</a></li>
                <li><a href="#feedback"><i class="fas fa-heart"></i> Eternal Feedback</a></li>
                <li><a href="/livestream-assistant.html" target="_blank"><i class="fas fa-video"></i> Livestream Assistant</a></li>
                <li><a href="/broadcast-scripts.html" target="_blank"><i class="fas fa-scroll"></i> Broadcast Scripts</a></li>
                <li><a href="/lander.html"><i class="fas fa-home"></i> Return to Sanctuary</a></li>
            </ul>
        </nav>
        
        <!-- Admin Mobile Navigation Toggle -->
        <button class="admin-nav-toggle" id="adminMobileNavToggle" aria-label="Toggle admin navigation">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="admin-user">
            <span id="adminUsername">Administrator</span>
        </div>
    </header>


    <!-- Admin Mobile Navigation Overlay -->
    <div class="admin-nav-overlay" id="mobileNavOverlay"></div>
    
    <!-- Admin Mobile Navigation Menu -->
    <nav class="admin-nav-mobile" id="mobileNavMenu">
        <div class="nav-header">
            <h3>Admin Menu</h3>
            <button class="nav-close" id="mobileNavClose" aria-label="Close navigation">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <ul>
            <li><a href="#dashboard" class="mobile-nav-link"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li><a href="#users" class="mobile-nav-link"><i class="fas fa-users"></i> Soul Management</a></li>
            <li><a href="#curation" class="mobile-nav-link"><i class="fas fa-star"></i> Content Curation</a></li>
            <li><a href="#analytics" class="mobile-nav-link"><i class="fas fa-chart-bar"></i> Eternal Analytics</a></li>
            <li><a href="#feedback" class="mobile-nav-link"><i class="fas fa-heart"></i> Eternal Feedback</a></li>
            <li><a href="/livestream-assistant.html" target="_blank" class="mobile-nav-link"><i class="fas fa-video"></i> Livestream Assistant</a></li>
            <li><a href="/broadcast-scripts.html" target="_blank" class="mobile-nav-link"><i class="fas fa-scroll"></i> Broadcast Scripts</a></li>
            <li><a href="/lander.html" class="mobile-nav-link"><i class="fas fa-home"></i> Return to Sanctuary</a></li>
        </ul>
    </nav>


    <main class="admin-container">
        <!-- Mobile Section Tabs -->
        <div class="mobile-section-tabs">
            <ul class="mobile-tabs-list">
                <li><a href="#dashboard" class="mobile-tab-btn active" data-section="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#users" class="mobile-tab-btn" data-section="users"><i class="fas fa-users"></i> Users</a></li>
                <li><a href="#curation" class="mobile-tab-btn" data-section="curation"><i class="fas fa-star"></i> Curation</a></li>
                <li><a href="#analytics" class="mobile-tab-btn" data-section="analytics"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                <li><a href="#feedback" class="mobile-tab-btn" data-section="feedback"><i class="fas fa-heart"></i> Feedback</a></li>
            </ul>
        </div>
        <!-- Dashboard Section -->
        <section id="dashboard" class="admin-section active">
            <h2 class="section-title">
                <i class="fas fa-crown"></i> Immortal's Overview
            </h2>
            
            <!-- Active Community Status -->
            <div class="community-status">
                <h3><i class="fas fa-users"></i> Active Community</h3>
                <div class="community-grid">
                    <div class="community-stat">
                        <span class="stat-label">Active Sessions (30d):</span>
                        <span class="stat-value" id="onlineUsers">--</span>
                    </div>
                    <div class="community-stat">
                        <span class="stat-label">Daily Active:</span>
                        <span class="stat-value" id="dailyActiveUsers">--</span>
                    </div>
                </div>
                <div class="recent-activity-list" id="recentActiveUsers">
                    <h4>Recent Activity (last 2h)</h4>
                    <div class="activity-loading">Loading recent souls...</div>
                </div>
            </div>

            <!-- Platform Health -->
            <div class="platform-health">
                <h3><i class="fas fa-heartbeat"></i> Platform Health</h3>
                <div class="health-grid">
                    <div class="health-stat">
                        <span class="stat-label">Server Response:</span>
                        <span class="stat-value" id="serverResponseTime">--</span>
                    </div>
                    <div class="health-stat">
                        <span class="stat-label">Failed Logins (24h):</span>
                        <span class="stat-value" id="failedLogins">--</span>
                    </div>
                    <div class="health-stat">
                        <span class="stat-label">Peak Hours:</span>
                        <span class="stat-value" id="peakHours">--</span>
                    </div>
                </div>
            </div>

            <div class="recent-activity">
                <div class="activity-header">
                    <h3>Recent Manifestations</h3>
                    <button id="refreshActivityFeed" class="refresh-btn" title="Refresh activity">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="activityFeed" class="activity-feed">
                    <p class="loading">Gathering cosmic data...</p>
                </div>
            </div>
        </section>

        <!-- User Management Section -->
        <section id="users" class="admin-section">
            <h2 class="section-title">
                <i class="fas fa-users-cog"></i> Soul Management
            </h2>
            
            
            <div class="management-controls">
                <div class="search-controls">
                    <div class="search-wrapper">
                        <input type="text" id="userSearch" placeholder="Search souls by username or display name..." />
                        <button id="searchBtn" class="search-btn" title="Search souls">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="filter-controls">
                    <select id="filterStatus">
                        <option value="all">All Souls</option>
                        <option value="online">Online Souls</option>
                        <option value="offline">Dormant Souls</option>
                        <option value="banned">Banished Souls</option>
                    </select>
                </div>
                <div class="cleanup-controls">
                    <button id="cleanupOnlineBtn" class="btn btn-warning" title="Clean up stale online users (>30 days old)">
                        <i class="fas fa-broom"></i> Cleanup Stale Online
                    </button>
                </div>
            </div>
            
            <div class="users-table-wrapper">
                <div class="table-responsive">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>Username</th>
                                <th>Display Name</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Last Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="loading">Summoning souls...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Mobile Table Cards -->
            <div class="mobile-table-cards" id="mobileUsersCards">
                <div class="loading">Summoning souls...</div>
            </div>
            
            <div class="pagination" id="usersPagination">
                <!-- Pagination controls will be generated here -->
            </div>
        </section>

        <!-- Content Curation Section -->
        <section id="curation" class="admin-section">
            <h2 class="section-title">
                <i class="fas fa-star"></i> Content Curation
            </h2>
            
            <div class="curation-overview">
                <div class="current-highlights-grid">
                    <div class="highlight-status-card">
                        <h3><i class="fas fa-scroll"></i> Soul Scrolls Editorial</h3>
                        <div id="currentSoulScrollsHighlight" class="current-highlight">
                            <div class="loading">Loading current selection...</div>
                        </div>
                        <button class="btn btn-primary" onclick="openCurationModal('soul-scrolls')">
                            <i class="fas fa-edit"></i> Select Editorial Choice
                        </button>
                    </div>
                    
                    <div class="highlight-status-card">
                        <h3><i class="fas fa-comments"></i> Echoes Unbound Editorial</h3>
                        <div id="currentEchoesHighlight" class="current-highlight">
                            <div class="loading">Loading current selection...</div>
                        </div>
                        <button class="btn btn-primary" onclick="openCurationModal('echoes-unbound')">
                            <i class="fas fa-edit"></i> Select Editorial Choice
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="admin-section">
            <h2 class="section-title">
                <i class="fas fa-chart-bar"></i> Eternal Analytics
                <button class="btn btn-outline analytics-help-btn" onclick="openAnalyticsTutorial()" title="View Analytics Guide">
                    <i class="fas fa-question-circle"></i> Help
                </button>
            </h2>
            
            <!-- Analytics Controls -->
            <div class="analytics-controls">
                <div class="time-range-selector">
                    <label for="analyticsTimeRange">Time Range:</label>
                    <select id="analyticsTimeRange">
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d" selected>Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="90d">Last 90 Days</option>
                        <option value="1y">Last Year</option>
                        <option value="total">Total (All Time)</option>
                    </select>
                </div>
                <button id="refreshAnalytics" class="btn btn-outline">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button id="exportAnalytics" class="btn btn-primary">
                    <i class="fas fa-download"></i> Export Report
                </button>
            </div>

            <!-- Tier 1: Core Traffic Metrics -->
            <div class="analytics-tier">
                <div class="tier-header">
                    <h3><i class="fas fa-rocket"></i> Site Traffic Overview</h3>
                </div>
                <div class="analytics-grid traffic-grid">
                    <div class="analytics-card highlight-card">
                        <div class="analytics-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="analytics-content">
                            <h4>Unique Visitors</h4>
                            <p class="analytics-number" id="uniqueVisitors">--</p>
                            <span class="metric-description">Registered + unregistered</span>
                        </div>
                    </div>

                    <div class="analytics-card highlight-card">
                        <div class="analytics-icon">
                            <i class="fas fa-mouse-pointer"></i>
                        </div>
                        <div class="analytics-content">
                            <h4>Number of Visits</h4>
                            <p class="analytics-number" id="totalVisits">--</p>
                            <span class="metric-description">Sessions started</span>
                        </div>
                    </div>

                    <div class="analytics-card highlight-card">
                        <div class="analytics-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="analytics-content">
                            <h4>Pages</h4>
                            <p class="analytics-number" id="totalPages">--</p>
                            <span class="metric-description">HTML page requests</span>
                        </div>
                    </div>

                    <div class="analytics-card highlight-card">
                        <div class="analytics-icon">
                            <i class="fas fa-mouse"></i>
                        </div>
                        <div class="analytics-content">
                            <h4>Hits</h4>
                            <p class="analytics-number" id="totalHits">--</p>
                            <span class="metric-description">All resource requests</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tier 2: Community Health -->
            <div class="analytics-tier">
                <div class="tier-header">
                    <h3><i class="fas fa-heart"></i> Community Activity</h3>
                </div>
                <div class="analytics-grid community-grid">
                    <div class="analytics-card highlight-card">
                        <div class="analytics-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="analytics-content">
                            <h4>Active Sessions</h4>
                            <p class="analytics-number" id="filteredActiveSessions">--</p>
                            <span class="metric-description">Valid sessions in timeframe</span>
                        </div>
                    </div>

                    <div class="analytics-card highlight-card">
                        <div class="analytics-icon">
                            <i class="fas fa-sign-in-alt"></i>
                        </div>
                        <div class="analytics-content">
                            <h4>User Logins</h4>
                            <p class="analytics-number" id="filteredLogins">--</p>
                            <span class="metric-description">Login events in timeframe</span>
                        </div>
                    </div>

                    <div class="analytics-card highlight-card">
                        <div class="analytics-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="analytics-content">
                            <h4>User Engagement</h4>
                            <p class="analytics-number" id="filteredEngagement">--</p>
                            <span class="metric-description">Posts, comments, votes</span>
                        </div>
                    </div>

                    <div class="analytics-card highlight-card">
                        <div class="analytics-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="analytics-content">
                            <h4>New Souls</h4>
                            <p class="analytics-number" id="filteredNewUsers">--</p>
                            <span class="metric-description">Registrations in timeframe</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tier 3: Content & Sources -->
            <div class="analytics-tier">
                <div class="tier-header">
                    <h3><i class="fas fa-chart-line"></i> Content & Traffic Sources</h3>
                </div>
                <div class="analytics-grid content-sources-grid">
                    <div class="analytics-list-container">
                        <h4><i class="fas fa-fire"></i> Popular Pages</h4>
                        <div id="popularPages" class="analytics-list">
                            <p class="loading">Loading...</p>
                        </div>
                    </div>

                    <div class="analytics-list-container">
                        <h4><i class="fas fa-external-link-alt"></i> Top Referrers</h4>
                        <div id="topReferrers" class="analytics-list">
                            <p class="loading">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tier 4: Detailed Insights (Collapsible) -->
            <div class="analytics-tier collapsible-tier">
                <div class="tier-header clickable" onclick="toggleAnalyticsTier(this)">
                    <h3><i class="fas fa-search"></i> Visitor Details</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="tier-content" style="display: none;">
                    <div class="analytics-grid details-grid">
                        <div class="analytics-list-container">
                            <h4><i class="fas fa-mobile-alt"></i> Device Types</h4>
                            <div id="deviceTypes" class="analytics-list">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>

                        <div class="analytics-list-container">
                            <h4><i class="fas fa-browser"></i> Browser Usage</h4>
                            <div id="browserUsage" class="analytics-list">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>

                        <div class="analytics-list-container">
                            <h4><i class="fas fa-globe"></i> Geographic Distribution</h4>
                            <div id="geographicData" class="analytics-list">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>

                        <div class="analytics-list-container">
                            <h4><i class="fas fa-search"></i> Search Queries</h4>
                            <div id="searchQueries" class="analytics-list">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tier 5: Community Leaders -->
            <div class="analytics-tier collapsible-tier">
                <div class="tier-header clickable" onclick="toggleAnalyticsTier(this)">
                    <h3><i class="fas fa-crown"></i> Community Leaders</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="tier-content" style="display: none;">
                    <div class="analytics-grid leaders-grid">
                        <div class="analytics-list-container">
                            <h4><i class="fas fa-trophy"></i> Most Active Souls</h4>
                            <div id="mostActiveSouls" class="analytics-list">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <div class="analytics-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="analytics-content">
                                <h4>Private Message Volume</h4>
                                <p class="analytics-number" id="privateMessageVolume">--</p>
                                <span class="metric-description">Messages sent today</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add JavaScript for tier collapsing -->
            <script>
            function toggleAnalyticsTier(header) {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.toggle-icon');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.style.transform = 'rotate(0deg)';
                    header.classList.remove('collapsed');
                } else {
                    content.style.display = 'none';
                    icon.style.transform = 'rotate(-90deg)';
                    header.classList.add('collapsed');
                }
            }
            </script>
        </section>
        <!-- Eternal Feedback Section -->
        <section id="feedback" class="admin-section">
            <h2 class="section-title">
                <i class="fas fa-heart"></i> Eternal Feedback
            </h2>
            
            <div class="management-controls">
                <div class="search-bar">
                    <input type="text" id="feedbackSearch" placeholder="Search feedback...">
                    <button id="searchFeedbackBtn"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="filter-controls">
                    <select id="feedbackFilter">
                        <option value="all">All Feedback</option>
                        <option value="unread">Unread</option>
                        <option value="read">Read</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <button id="refreshFeedbackBtn" class="btn btn-outline">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div class="feedback-table-wrapper">
                <div class="table-responsive">
                    <table class="feedback-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Content</th>
                                <th>Sender</th>
                                <th>Reply</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody id="feedbackTableBody">
                            <tr><td colspan="5" class="loading">Summoning immortal feedback...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Mobile Feedback Cards -->
            <div class="mobile-table-cards" id="mobileFeedbackCards">
                <div class="loading">Summoning immortal feedback...</div>
            </div>
        </section>
    </main>

    <!-- Active Users Sidebar, Floating Buttons, and Message Modal will be dynamically injected by shared components -->

    <!-- Authentication Modal -->
    <div id="soulModal" class="soul-modal" aria-hidden="true">
        <div class="soul-modal-content" role="dialog" aria-labelledby="soulModalTitle">
            <h2 id="soulModalTitle">Enter the Eternal Realm</h2>
            <div class="soul-modal-body">
                <!-- Auth form will be populated by authModal.js -->
            </div>
        </div>
    </div>

    <!-- User Action Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <h3 id="modalTitle">Soul Details</h3>
            <div id="modalContent">
                <!-- User details and actions will be populated here -->
            </div>
        </div>
    </div>

    <!-- Message Modal for Replies -->
    <div id="messageModal" class="modal" aria-hidden="true">
        <div class="message-modal-content" role="dialog" aria-labelledby="messageTitle">
            <h3 id="messageTitle">Direct Message</h3>
            <p id="recipientName">To: Username</p>
            <div class="message-history" id="messageHistory"></div>
            <div>
                <input type="text" id="messageInput" placeholder="Inscribe your eternal message..." required>
                <div class="modal-actions">
                    <button type="submit" id="sendMessageBtn">Send Whisper</button>
                    <button type="button" id="closeMessageModal">Close Nexus</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Curation Modal -->
    <div id="curationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="curationModalTitle">Select Editorial Choice</h3>
                <button class="modal-close" onclick="closeCurationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="content-search">
                    <input type="text" id="contentSearch" placeholder="Search content...">
                    <button onclick="searchContent()"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="content-type-tabs">
                    <button class="tab-btn active" data-type="blogs">Soul Scrolls</button>
                    <button class="tab-btn" data-type="threads">Echoes Unbound</button>
                </div>
                
                <div class="content-list" id="contentList">
                    <div class="loading">Loading content...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCurationModal()">Cancel</button>
                <button class="btn btn-primary" id="featureContentBtn" onclick="featureSelectedContent()" disabled>
                    <i class="fas fa-star"></i> Feature Content
                </button>
            </div>
        </div>
    </div>

    <!-- Analytics Tutorial Modal -->
    <div id="analyticsTutorial" class="modal analytics-tutorial-modal" aria-hidden="true">
        <div class="modal-content tutorial-content">
            <button class="close-modal" onclick="closeAnalyticsTutorial()">&times;</button>
            <h2><i class="fas fa-graduation-cap"></i> Eternal Analytics Guide</h2>
            
            <div class="tutorial-sections">
                <!-- Overview Section -->
                <div class="tutorial-section">
                    <h3><i class="fas fa-info-circle"></i> Overview</h3>
                    <p>The Eternal Analytics dashboard provides comprehensive insights into your site's performance and user engagement. All metrics update in real-time to give you the most current data.</p>
                </div>

                <!-- Visitor Metrics -->
                <div class="tutorial-section">
                    <h3><i class="fas fa-users"></i> Visitor Metrics</h3>
                    <div class="metric-explanation">
                        <h4><i class="fas fa-eye"></i> Total Page Views</h4>
                        <p>The total number of pages viewed on your site. Repeated views of a single page are counted.</p>
                    </div>
                    <div class="metric-explanation">
                        <h4><i class="fas fa-users"></i> Unique Visitors</h4>
                        <p>The number of individual users who have visited your site, counted only once per time period.</p>
                    </div>
                    <div class="metric-explanation">
                        <h4><i class="fas fa-clock"></i> Average Session Duration</h4>
                        <p>The average length of time users spend on your site during a single visit.</p>
                    </div>
                    <div class="metric-explanation">
                        <h4><i class="fas fa-percentage"></i> Bounce Rate</h4>
                        <p>The percentage of visitors who leave your site after viewing only one page. Lower is better!</p>
                    </div>
                </div>

                <!-- Real-Time Metrics -->
                <div class="tutorial-section">
                    <h3><i class="fas fa-globe"></i> Real-Time Metrics</h3>
                    <div class="metric-explanation">
                        <h4><i class="fas fa-globe"></i> Online Now</h4>
                        <p>The number of users currently active on your site. Updates every few seconds.</p>
                    </div>
                    <div class="metric-explanation">
                        <h4><i class="fas fa-chart-line"></i> Page Load Speed</h4>
                        <p>Average time it takes for pages to fully load. Aim for under 3 seconds for optimal user experience.</p>
                    </div>
                </div>

                <!-- Legacy Metrics -->
                <div class="tutorial-section">
                    <h3><i class="fas fa-history"></i> Legacy Metrics</h3>
                    <div class="metric-explanation">
                        <h4>Daily Active Souls</h4>
                        <p>Registered users who have logged in and performed actions in the last 24 hours.</p>
                    </div>
                    <div class="metric-explanation">
                        <h4>Content Creation Rate</h4>
                        <p>Average number of new posts, messages, and comments created per day.</p>
                    </div>
                    <div class="metric-explanation">
                        <h4>Engagement Score</h4>
                        <p>A composite score (0-100) based on user interactions, content creation, and session quality.</p>
                    </div>
                    <div class="metric-explanation">
                        <h4>Error Rate</h4>
                        <p>Percentage of page loads that result in errors. Should be below 1% for good user experience.</p>
                    </div>
                </div>

                <!-- Time Range Tips -->
                <div class="tutorial-section">
                    <h3><i class="fas fa-calendar"></i> Using Time Ranges</h3>
                    <p>Select different time ranges to analyze trends:</p>
                    <ul>
                        <li><strong>Last 24 Hours:</strong> Best for monitoring immediate changes and real-time issues</li>
                        <li><strong>Last 7 Days:</strong> Ideal for weekly patterns and recent trends</li>
                        <li><strong>Last 30 Days:</strong> Good for monthly overview and content performance</li>
                        <li><strong>Last 90 Days:</strong> Useful for quarterly analysis and seasonal patterns</li>
                        <li><strong>Last Year:</strong> Perfect for long-term growth tracking and yearly comparisons</li>
                    </ul>
                </div>

                <!-- Charts Guide -->
                <div class="tutorial-section">
                    <h3><i class="fas fa-chart-bar"></i> Understanding Charts</h3>
                    <p><strong>Visitor Traffic Chart:</strong> Shows page views and unique visitors over time. Look for patterns and spikes.</p>
                    <p><strong>User Activity Patterns:</strong> Displays when users are most active. Use this to schedule content and maintenance.</p>
                    <p><strong>Device & Browser Charts:</strong> Helps you understand what devices and browsers to optimize for.</p>
                </div>
            </div>

            <div class="tutorial-footer">
                <button class="btn btn-primary" onclick="closeAnalyticsTutorial()">
                    <i class="fas fa-check"></i> Got It!
                </button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2023 Immortal Nexus. Administrator Access Only.</p>
        <p>With great power comes eternal responsibility.</p>
    </footer>

    <!-- Config MUST be loaded first -->
    <script src="../components/shared/config.js?v=2.0"></script>
    
    <!-- Admin Authentication Check -->
    <script>
        // Check if user is logged in and has admin role
        (function() {
            const token = localStorage.getItem('sessionToken');
            if (!token) {
                alert('Admin access requires authentication. Redirecting to login...');
                window.location.href = '/?login=admin';
                return;
            }
            
            // Verify admin role via API  
            const apiBaseUrl = window.NEXUS_CONFIG?.API_BASE_URL || 'https://nexus-ytrg.onrender.com/api';
            console.log('Auth check - API base URL:', apiBaseUrl);
            fetch(`${apiBaseUrl}/debug/whoami`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.isAdmin) {
                    alert('Admin access denied. Insufficient privileges.');
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.warn('Could not verify admin status:', error);
                // Continue loading - might be offline or local development
            });
        })();
    </script>
    
    <!-- Config already loaded above -->
    
    <!-- Theme Manager - Load early for immediate theme application -->
    <script src="../components/shared/themeManager.js?v=2.2"></script>
    
    <!-- Core Immortal Nexus Components -->
    <script src="../components/shared/nexus-core.js?v=1.5"></script>
    <script src="../components/shared/authManager.js?v=1.3"></script>
    <script src="../components/shared/authModal.js?v=1.2"></script>
    <script src="../components/shared/apiClient.js?v=1.4"></script>
    <script src="../components/shared/navigation.js?v=2.1"></script>
    <script src="../components/shared/userMenu.js?v=7.2"></script>

    <!-- Avatar System (MUST load before activeUsers.js) -->
    <script src="../js/nexus-avatar-system.js?v=3.1"></script>

    <script src="../components/shared/activeUsers.js?v=2.3"></script>
    <script src="../components/shared/messageModal.js?v=1.7"></script>
    
    <!-- Admin Components -->
    <script src="../js/admin/dashboard.js?v=1.3"></script>
    <script src="../js/admin/userManagement.js?v=1.8"></script>
    <script src="../js/admin/analytics.js?v=1.3"></script>
    <script src="../js/admin/feedback.js?v=2.4"></script>
    
    <!-- Analytics Tracking System -->
    <script src="../js/analytics-tracker.js?v=2.0" async></script>
    
    <!-- Content Curation System -->
    <script>
        // Content Curation System
        let currentCurationSection = '';
        let currentContentType = 'blogs';
        let selectedContentId = null;
        let selectedContentData = null;
        
        function openCurationModal(section) {
            // Convert frontend section names to backend enum values
            const sectionMapping = {
                'soul-scrolls': 'soul_scrolls',
                'echoes-unbound': 'echoes_unbound'
            };
            currentCurationSection = sectionMapping[section] || section;
            currentContentType = section === 'soul-scrolls' ? 'blogs' : 'threads';
            
            const modal = document.getElementById('curationModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
            } else {
                console.error('Curation modal not found!');
                return;
            }
            
            const modalTitle = document.getElementById('curationModalTitle');
            if (modalTitle) {
                modalTitle.textContent = section === 'soul-scrolls' ? 'Select Soul Scrolls Editorial Choice' : 'Select Echoes Unbound Editorial Choice';
            } else {
                console.error('Modal title element not found');
            }
            
            // Update tab visibility
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.style.display = section === 'soul-scrolls' && tab.dataset.type === 'threads' ? 'none' : 'block';
                tab.classList.toggle('active', tab.dataset.type === currentContentType);
            });
            
            loadContentForCuration();
        }
        
        function closeCurationModal() {
            const modal = document.getElementById('curationModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
            }
            selectedContentId = null;
            selectedContentData = null;
            
            // Reset button state
            const featureBtn = document.getElementById('featureContentBtn');
            if (featureBtn) {
                featureBtn.disabled = true;
                featureBtn.innerHTML = '<i class="fas fa-star"></i> Feature Content';
                featureBtn.classList.remove('btn-ready');
                featureBtn.style.animation = '';
            }
            
            // Clear all selections
            document.querySelectorAll('.content-item').forEach(item => {
                item.classList.remove('selected');
            });
        }
        
        async function loadContentForCuration() {
            const contentList = document.getElementById('contentList');
            if (!contentList) {
                console.error('contentList element not found');
                return;
            }
            
            contentList.innerHTML = '<div class="loading">Loading content...</div>';
            
            try {
                if (!window.NEXUS_CONFIG || !window.NEXUS_CONFIG.API_BASE_URL) {
                    throw new Error('API configuration not available');
                }
                
                const endpoint = currentContentType === 'blogs' ? '/blogs' : '/threads';
                const token = localStorage.getItem('sessionToken');
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const url = `${window.NEXUS_CONFIG.API_BASE_URL}${endpoint}?limit=20&populate=author`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error(`Failed to fetch content: ${response.status}`);
                
                const data = await response.json();
                
                // Handle different API response formats
                let content = [];
                if (Array.isArray(data)) {
                    content = data;
                } else if (data.docs && Array.isArray(data.docs)) {
                    content = data.docs;
                } else if (data.threads && Array.isArray(data.threads)) {
                    content = data.threads;
                } else if (data.data && Array.isArray(data.data)) {
                    content = data.data;
                } else {
                    console.warn('Unexpected content response format:', data);
                    contentList.innerHTML = '<div class="error">No content available</div>';
                    return;
                }
                
                displayContentForCuration(content);
                
            } catch (error) {
                console.error('Error loading content:', error);
                contentList.innerHTML = '<div class="error">Failed to load content</div>';
            }
        }
        
        function displayContentForCuration(content) {
            const contentList = document.getElementById('contentList');
            
            if (content.length === 0) {
                contentList.innerHTML = '<div class="empty">No content available</div>';
                return;
            }
            
            contentList.innerHTML = content.map(item => {
                
                // Handle missing or invalid items
                if (!item || !item._id) {
                    console.warn('Invalid item found:', item);
                    return '<div class="content-item error">Invalid content item</div>';
                }
                
                const date = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'Unknown date';
                const author = item.author?.username || 'Anonymous';
                const excerpt = (item.content || item.description || 'No content available').replace(/<[^>]*>/g, '').substring(0, 150) + '...';
                const title = item.title || 'Untitled';
                
                return `
                    <div class="content-item" data-content-id="${item._id}" onclick="selectContent('${item._id}')">
                        <div class="content-header">
                            <h4>${title}</h4>
                            <span class="content-meta">by ${author} • ${date}</span>
                        </div>
                        <p class="content-excerpt">${excerpt}</p>
                        <div class="content-footer">
                            <span class="content-type">${currentContentType === 'blogs' ? 'Soul Scroll' : 'Echo Thread'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectContent(contentId) {
            // Remove previous selection with smooth transition
            document.querySelectorAll('.content-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current item with enhanced feedback
            const selectedElement = document.querySelector(`[data-content-id="${contentId}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
                selectedContentId = contentId;
                selectedContentData = { _id: contentId }; // Store minimal data
                
                // Update button state with visual feedback
                const featureBtn = document.getElementById('featureContentBtn');
                featureBtn.disabled = false;
                featureBtn.innerHTML = '<i class="fas fa-star"></i> Feature Selected Content';
                featureBtn.classList.add('btn-ready');
                
                // Scroll selected item into view if needed
                selectedElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
                
                // Show confirmation message
                const contentTitle = selectedElement.querySelector('.content-header h4')?.textContent || 'Content';
                
                // Add subtle pulse effect to the button
                featureBtn.style.animation = 'pulse-ready 1s ease';
                setTimeout(() => {
                    featureBtn.style.animation = '';
                }, 1000);
            }
        }
        
        async function featureSelectedContent() {
            if (!selectedContentId) {
                alert('Please select content to feature');
                return;
            }
            
            try {
                const token = localStorage.getItem('sessionToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                // Verify user is admin
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                if (user.role !== 'admin') {
                    throw new Error('Admin role required for content curation');
                }
                
                const requestBody = {
                    contentType: currentContentType === 'blogs' ? 'blog' : 'thread',
                    contentId: selectedContentId,
                    section: currentCurationSection,
                    adminNotes: 'Featured via admin curation interface'
                };
                
                
                const response = await fetch(`${window.NEXUS_CONFIG.API_BASE_URL}/highlights/admin-feature`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                
                if (!response.ok) {
                    let errorText;
                    try {
                        const errorJson = await response.json();
                        errorText = errorJson.error || JSON.stringify(errorJson);
                        console.error('API Error JSON:', errorJson);
                    } catch (parseError) {
                        errorText = await response.text();
                        console.error('API Error Text:', errorText);
                    }
                    
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                alert('Content successfully featured!');
                closeCurationModal();
                loadCurrentHighlights();
                
            } catch (error) {
                console.error('Error featuring content:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                alert(`Failed to feature content: ${error.message}`);
            }
        }
        
        async function loadCurrentHighlights() {
            // Load current Soul Scrolls highlight
            try {
                const response = await fetch(`${window.NEXUS_CONFIG.API_BASE_URL}/highlights/soul_scrolls`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const adminHighlight = data.highlights?.find(h => h.type === 'admin');
                    
                    const container = document.getElementById('currentSoulScrollsHighlight');
                    if (adminHighlight && container) {
                        container.innerHTML = `
                            <div class="featured-content">
                                <h4>${adminHighlight.content.title}</h4>
                                <p>by ${adminHighlight.content.author?.username || 'Anonymous'}</p>
                                <small>Featured: ${new Date(adminHighlight.content.createdAt).toLocaleDateString()}</small>
                            </div>
                        `;
                    } else if (container) {
                        container.innerHTML = '<div class="no-selection">No editorial selection</div>';
                    }
                }
                
                // Load current Echoes Unbound highlight
                const echoesResponse = await fetch(`${window.NEXUS_CONFIG.API_BASE_URL}/highlights/echoes_unbound`);
                
                if (echoesResponse.ok) {
                    const echoesData = await echoesResponse.json();
                    
                    const echoesAdminHighlight = echoesData.highlights?.find(h => h.type === 'admin');
                    
                    const echoesContainer = document.getElementById('currentEchoesHighlight');
                    if (echoesAdminHighlight && echoesContainer) {
                        echoesContainer.innerHTML = `
                            <div class="featured-content">
                                <h4>${echoesAdminHighlight.content.title}</h4>
                                <p>by ${echoesAdminHighlight.content.author?.username || 'Anonymous'}</p>
                                <small>Featured: ${new Date(echoesAdminHighlight.content.createdAt).toLocaleDateString()}</small>
                            </div>
                        `;
                    } else if (echoesContainer) {
                        echoesContainer.innerHTML = '<div class="no-selection">No editorial selection</div>';
                    }
                }
                
            } catch (error) {
                console.error('Error loading current highlights:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
            }
        }
        
        // Tab switching
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-btn')) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentContentType = e.target.dataset.type;
                selectedContentId = null;
                selectedContentData = null;
                
                // Reset button state when switching tabs
                const featureBtn = document.getElementById('featureContentBtn');
                featureBtn.disabled = true;
                featureBtn.innerHTML = '<i class="fas fa-star"></i> Feature Content';
                featureBtn.classList.remove('btn-ready');
                featureBtn.style.animation = '';
                
                loadContentForCuration();
            }
        });
        
        // Search functionality
        function searchContent() {
            const searchTerm = document.getElementById('contentSearch').value;
            // Could implement search API call here
            loadContentForCuration();
        }
        
        // Modal close on background click
        document.addEventListener('click', function(e) {
            if (e.target.id === 'curationModal') {
                closeCurationModal();
            }
        });

        // Analytics Tutorial Functions
        function openAnalyticsTutorial() {
            const tutorial = document.getElementById('analyticsTutorial');
            if (tutorial) {
                tutorial.style.display = 'flex';
                tutorial.classList.add('active');
                tutorial.setAttribute('aria-hidden', 'false');
            }
        }

        function closeAnalyticsTutorial() {
            const tutorial = document.getElementById('analyticsTutorial');
            if (tutorial) {
                tutorial.style.display = 'none';
                tutorial.classList.remove('active');
                tutorial.setAttribute('aria-hidden', 'true');
            }
        }

        // Close tutorial on background click
        document.addEventListener('click', function(e) {
            if (e.target.id === 'analyticsTutorial') {
                closeAnalyticsTutorial();
            }
        });
    </script>

    <!-- Initialize Immortal Nexus -->
    <script>
        // Core Admin Navigation Function (independent of AdminDashboard)
        function initAdminNavigation() {
            console.log('Initializing core admin navigation...');
            
            // Handle all admin navigation links
            const adminNavLinks = document.querySelectorAll('.admin-nav a[href^="#"], .mobile-nav-link[href^="#"], .mobile-tab-btn[data-section]');
            
            adminNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetSection = link.getAttribute('href')?.substring(1) || link.dataset.section;
                    
                    if (targetSection && targetSection !== '/') {
                        switchAdminSection(targetSection);
                        updateActiveNavStates(targetSection);
                        
                        // Update URL hash
                        window.history.replaceState(null, null, `#${targetSection}`);
                        
                        // Close mobile nav if open
                        toggleMobileNav(false);
                    } else if (link.getAttribute('href') === '/lander.html') {
                        // Handle home link
                        window.location.href = '/lander.html';
                    }
                });
            });
            
            // Handle initial section based on URL hash
            const initialSection = window.location.hash.substring(1) || 'dashboard';
            switchAdminSection(initialSection);
            updateActiveNavStates(initialSection);
        }
        
        function switchAdminSection(sectionName) {
            console.log('Switching to section:', sectionName);
            
            // Hide all sections
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => {
                section.classList.remove('active');
            });

            // Show target section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Load section-specific data
                loadSectionData(sectionName);
            } else {
                console.error(`Admin section not found: ${sectionName}`);
                // Fallback to dashboard
                const dashboardSection = document.getElementById('dashboard');
                if (dashboardSection) {
                    dashboardSection.classList.add('active');
                    loadSectionData('dashboard');
                }
            }
        }
        
        function updateActiveNavStates(activeSection) {
            // Update desktop navigation
            const desktopNavLinks = document.querySelectorAll('.admin-nav a[href^="#"]');
            desktopNavLinks.forEach(link => {
                const section = link.getAttribute('href').substring(1);
                link.classList.toggle('active', section === activeSection);
            });

            // Update mobile navigation
            const mobileNavLinks = document.querySelectorAll('.mobile-nav-link[href^="#"]');
            mobileNavLinks.forEach(link => {
                const section = link.getAttribute('href').substring(1);
                link.classList.toggle('active', section === activeSection);
            });

            // Update mobile tab buttons
            const mobileTabBtns = document.querySelectorAll('.mobile-tab-btn[data-section]');
            mobileTabBtns.forEach(btn => {
                const section = btn.dataset.section;
                btn.classList.toggle('active', section === activeSection);
            });
        }
        
        function loadSectionData(sectionName) {
            console.log('Loading data for section:', sectionName);
            
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'analytics':
                    loadAnalyticsData();
                    break;
                case 'feedback':
                    loadFeedbackData();
                    break;
                case 'curation':
                    loadCurationData();
                    break;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize core admin navigation first
            initAdminNavigation();
            
            // Initialize Immortal Nexus core components (gracefully handle missing elements on admin page)
            
            // Ensure ImmortalNexus object exists
            window.ImmortalNexus = window.ImmortalNexus || {};
            
            if (typeof ImmortalNexus !== 'undefined') {
                try {
                    ImmortalNexus.initThemeManager();
                } catch (error) {
                    console.warn('Theme manager init skipped on admin page:', error.message);
                }
                
                try {
                    ImmortalNexus.initNavigation();
                } catch (error) {
                    console.warn('Navigation init failed:', error.message);
                }
                
                try {
                    ImmortalNexus.initUserMenu();
                } catch (error) {
                    console.warn('User menu init failed:', error.message);
                }
                
                try {
                    ImmortalNexus.initAuthModal();
                } catch (error) {
                    console.warn('Auth modal init skipped on admin page:', error.message);
                }
                
                try {
                    ImmortalNexus.initMessageModal();
                } catch (error) {
                    console.warn('Message modal init skipped on admin page:', error.message);
                }
            }
            
            // Initialize active users with proper error handling
            setTimeout(() => {
                if (typeof ImmortalNexus !== 'undefined' && typeof ImmortalNexus.initActiveUsers === 'function') {
                    try {
                        ImmortalNexus.initActiveUsers();
                    } catch (error) {
                        console.error('Error initializing active users:', error);
                    }
                } else if (typeof initActiveUsers === 'function') {
                    try {
                        initActiveUsers();
                    } catch (error) {
                        console.error('Error with global initActiveUsers:', error);
                    }
                }
            }, 1000);
            
            // Initialize floating buttons
            initFloatingButtons();
            
            // Initialize admin components with delay to ensure all scripts are loaded
            setTimeout(() => {
                if (typeof AdminDashboard !== 'undefined') {
                    AdminDashboard.init();
                }
                
                if (typeof AdminAnalytics !== 'undefined') {
                    AdminAnalytics.init();
                }
                
                if (typeof AdminFeedback !== 'undefined') {
                    AdminFeedback.init();
                }
            }, 500);
            
            // Initialize curation highlights
            setTimeout(loadCurrentHighlights, 1000);
            
            // Initialize mobile navigation
            initMobileNavigation();
        });
        
        // Floating Buttons Functions
        function initFloatingButtons() {
            const themeToggle = document.querySelector('[data-theme-toggle]');
            
            // Active users button is now handled by activeUsers.js
            // No need for duplicate event handling here
            
            // Theme toggle button
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    // Use Immortal Nexus theme toggle if available
                    if (typeof ImmortalNexus !== 'undefined' && typeof ImmortalNexus.toggleTheme === 'function') {
                        ImmortalNexus.toggleTheme();
                    } else {
                        // Fallback theme toggle
                        document.body.classList.toggle('dark-theme');
                        const icon = themeToggle.querySelector('i');
                        if (icon) {
                            icon.classList.toggle('fa-moon');
                            icon.classList.toggle('fa-sun');
                        }
                    }
                });
            }
        }
        
        // Mobile Navigation Functions
        function initMobileNavigation() {
            const adminMobileNavToggle = document.getElementById('adminMobileNavToggle');
            const mobileNavOverlay = document.getElementById('mobileNavOverlay');
            const mobileNavMenu = document.getElementById('mobileNavMenu');
            const mobileNavClose = document.getElementById('mobileNavClose');
            
            // Admin mobile nav toggle
            if (adminMobileNavToggle) {
                adminMobileNavToggle.addEventListener('click', () => {
                    toggleMobileNav(true);
                });
            }
            
            // Mobile nav close
            if (mobileNavClose) {
                mobileNavClose.addEventListener('click', () => {
                    toggleMobileNav(false);
                });
            }
            
            // Overlay click to close
            if (mobileNavOverlay) {
                mobileNavOverlay.addEventListener('click', () => {
                    toggleMobileNav(false);
                });
            }
            
            // Mobile nav links
            const mobileNavLinks = document.querySelectorAll('.mobile-nav-link, .mobile-tab-btn');
            mobileNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('href').substring(1) || link.dataset.section;
                    if (section && section !== '/') {
                        // Switch section using existing AdminDashboard function
                        if (typeof AdminDashboard !== 'undefined' && AdminDashboard.switchSection) {
                            AdminDashboard.switchSection(section);
                        }
                        // Update active states
                        updateMobileNavActiveStates(section);
                    }
                    // Close mobile nav
                    toggleMobileNav(false);
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    toggleMobileNav(false);
                }
            });
        }
        
        function toggleMobileNav(show) {
            const mobileNavOverlay = document.getElementById('mobileNavOverlay');
            const mobileNavMenu = document.getElementById('mobileNavMenu');
            
            if (show) {
                if (mobileNavOverlay) {
                    mobileNavOverlay.style.display = 'block';
                }
                if (mobileNavMenu) {
                    mobileNavMenu.style.display = 'block';
                    // Force reflow then add active class for animation
                    mobileNavMenu.offsetHeight;
                    mobileNavMenu.classList.add('active');
                }
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            } else {
                if (mobileNavMenu) {
                    mobileNavMenu.classList.remove('active');
                    setTimeout(() => {
                        if (mobileNavMenu) mobileNavMenu.style.display = 'none';
                    }, 300);
                }
                if (mobileNavOverlay) {
                    mobileNavOverlay.style.display = 'none';
                }
                // Restore body scroll
                document.body.style.overflow = '';
            }
        }
        
        function updateMobileNavActiveStates(activeSection) {
            // Update mobile tab buttons
            const tabBtns = document.querySelectorAll('.mobile-tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === activeSection);
            });
            
            // Update desktop nav links
            const navLinks = document.querySelectorAll('.admin-nav a');
            navLinks.forEach(link => {
                const section = link.getAttribute('href').substring(1);
                link.classList.toggle('active', section === activeSection);
            });
        }
        
        // Data loading functions for each section
        function loadDashboardData() {
            console.log('Loading dashboard data...');
            
            // Always use real AdminDashboard data if available
            if (typeof AdminDashboard !== 'undefined' && AdminDashboard.loadDashboardData) {
                AdminDashboard.loadDashboardData();
            } else {
                console.error('AdminDashboard not available - loading from API directly');
                loadRealDashboardData();
            }
        }
        
        function loadSampleDashboardData() {
            // Update stats with sample data
            const elements = {
                onlineUsers: document.getElementById('onlineUsers'),
                dailyActiveUsers: document.getElementById('dailyActiveUsers'),
                serverResponseTime: document.getElementById('serverResponseTime'),
                failedLogins: document.getElementById('failedLogins'),
                peakHours: document.getElementById('peakHours')
            };
            
            // Sample data
            if (elements.onlineUsers) elements.onlineUsers.textContent = '42';
            if (elements.dailyActiveUsers) elements.dailyActiveUsers.textContent = '127';
            if (elements.serverResponseTime) elements.serverResponseTime.textContent = '85ms';
            if (elements.failedLogins) elements.failedLogins.textContent = '3';
            if (elements.peakHours) elements.peakHours.textContent = '2-4 PM EST';
            
            // Load sample activity feed
            const activityFeed = document.getElementById('activityFeed');
            if (activityFeed) {
                activityFeed.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-message">EternalSeeker joined the eternal realm</p>
                            <span class="activity-time">2m ago</span>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-scroll"></i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-message">MysticSoul published "The Path to Enlightenment"</p>
                            <span class="activity-time">15m ago</span>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-message">CosmicWisdom started "Ancient Mysteries Unveiled"</p>
                            <span class="activity-time">32m ago</span>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-message">Content highlighted: "Digital Transcendence"</p>
                            <span class="activity-time">1h ago</span>
                        </div>
                    </div>
                `;
            }
        }
        
        function loadUsersData() {
            console.log('Loading users data...');
            
            // Always try to load real user data first
            if (typeof UserManagement !== 'undefined' && UserManagement.loadUsers) {
                if (!UserManagement.apiBaseUrl) {
                    UserManagement.init();
                } else {
                    UserManagement.loadUsers();
                }
            } else {
                console.error('UserManagement not available - loading from API directly');
                loadRealUsersData();
            }
        }
        
        function loadSampleUsersData() {
            const usersTableBody = document.getElementById('usersTableBody');
            if (usersTableBody) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td><div class="user-avatar" style="background: linear-gradient(45deg, #667eea, #764ba2);">ES</div></td>
                        <td>EternalSeeker</td>
                        <td>The Eternal Seeker</td>
                        <td><span class="status-badge online">Online</span></td>
                        <td>2 days ago</td>
                        <td>2 minutes ago</td>
                        <td>
                            <button class="btn btn-sm btn-outline" title="View Profile">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" title="Send Message">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><div class="user-avatar" style="background: linear-gradient(45deg, #f093fb, #f5576c);">MS</div></td>
                        <td>MysticSoul</td>
                        <td>Mystic Soul</td>
                        <td><span class="status-badge online">Online</span></td>
                        <td>1 week ago</td>
                        <td>15 minutes ago</td>
                        <td>
                            <button class="btn btn-sm btn-outline" title="View Profile">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" title="Send Message">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><div class="user-avatar" style="background: linear-gradient(45deg, #4facfe, #00f2fe);">CW</div></td>
                        <td>CosmicWisdom</td>
                        <td>Cosmic Wisdom</td>
                        <td><span class="status-badge offline">Offline</span></td>
                        <td>3 weeks ago</td>
                        <td>2 hours ago</td>
                        <td>
                            <button class="btn btn-sm btn-outline" title="View Profile">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" title="Send Message">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        function loadAnalyticsData() {
            console.log('Loading analytics data...');
            
            // Always prioritize real analytics data
            if (typeof AdminAnalytics !== 'undefined' && AdminAnalytics.loadAnalytics) {
                AdminAnalytics.loadAnalytics();
            } else {
                console.error('AdminAnalytics not available - loading from API directly');
                loadRealAnalyticsData();
            }
        }
        
        function loadSampleAnalyticsData() {
            // Update analytics with sample data
            const analyticsElements = {
                uniqueVisitors: document.getElementById('uniqueVisitors'),
                totalVisits: document.getElementById('totalVisits'),
                totalPages: document.getElementById('totalPages'),
                totalHits: document.getElementById('totalHits')
            };
            
            if (analyticsElements.uniqueVisitors) analyticsElements.uniqueVisitors.textContent = '2,847';
            if (analyticsElements.totalVisits) analyticsElements.totalVisits.textContent = '4,291';
            if (analyticsElements.totalPages) analyticsElements.totalPages.textContent = '12,384';
            if (analyticsElements.totalHits) analyticsElements.totalHits.textContent = '47,592';
        }
        
        function loadFeedbackData() {
            console.log('Loading feedback data...');
            
            // Always try to load real feedback data first
            if (typeof AdminFeedback !== 'undefined' && AdminFeedback.loadFeedback) {
                AdminFeedback.loadFeedback();
            } else {
                console.error('AdminFeedback not available - loading from API directly');
                loadRealFeedbackData();
            }
        }
        
        function loadSampleFeedbackData() {
            const feedbackTableBody = document.getElementById('feedbackTableBody');
            if (feedbackTableBody) {
                feedbackTableBody.innerHTML = `
                    <tr class="feedback-unread">
                        <td>2 hours ago</td>
                        <td class="feedback-content">
                            <div class="feedback-text">"The new mindmap feature is incredible! It's helped me visualize my spiritual journey in ways I never thought possible. Thank you for creating such a meaningful platform."</div>
                            <div class="feedback-meta">
                                <span class="feedback-type">Feature Appreciation</span>
                                <span class="feedback-urgency normal">Normal</span>
                            </div>
                        </td>
                        <td>
                            <div class="sender-info">
                                <div class="sender-avatar" style="background: linear-gradient(45deg, #667eea, #764ba2);">ES</div>
                                <div class="sender-details">
                                    <div class="sender-name">EternalSeeker</div>
                                    <div class="sender-email">seeker@eternal.com</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary reply-btn" title="Reply to feedback">
                                <i class="fas fa-reply"></i> Reply
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-btn" title="Delete feedback">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <tr class="feedback-read">
                        <td>1 day ago</td>
                        <td class="feedback-content">
                            <div class="feedback-text">"I've been experiencing some issues with the comment system. Sometimes my comments don't appear immediately. Could you look into this?"</div>
                            <div class="feedback-meta">
                                <span class="feedback-type">Bug Report</span>
                                <span class="feedback-urgency high">High Priority</span>
                            </div>
                        </td>
                        <td>
                            <div class="sender-info">
                                <div class="sender-avatar" style="background: linear-gradient(45deg, #f093fb, #f5576c);">MS</div>
                                <div class="sender-details">
                                    <div class="sender-name">MysticSoul</div>
                                    <div class="sender-email">mystic@cosmos.net</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline replied-btn" title="Already replied">
                                <i class="fas fa-check"></i> Replied
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-btn" title="Delete feedback">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <tr class="feedback-urgent">
                        <td>3 days ago</td>
                        <td class="feedback-content">
                            <div class="feedback-text">"I love the concept of Nexus, but I think we need more discussion categories. Perhaps sections for different philosophical schools or spiritual practices?"</div>
                            <div class="feedback-meta">
                                <span class="feedback-type">Suggestion</span>
                                <span class="feedback-urgency normal">Normal</span>
                            </div>
                        </td>
                        <td>
                            <div class="sender-info">
                                <div class="sender-avatar" style="background: linear-gradient(45deg, #4facfe, #00f2fe);">CW</div>
                                <div class="sender-details">
                                    <div class="sender-name">CosmicWisdom</div>
                                    <div class="sender-email">wisdom@universe.org</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary reply-btn" title="Reply to feedback">
                                <i class="fas fa-reply"></i> Reply
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-btn" title="Delete feedback">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <tr class="feedback-read">
                        <td>1 week ago</td>
                        <td class="feedback-content">
                            <div class="feedback-text">"The mobile experience could use some improvements. The navigation menu sometimes doesn't respond properly on my phone."</div>
                            <div class="feedback-meta">
                                <span class="feedback-type">UX Feedback</span>
                                <span class="feedback-urgency high">High Priority</span>
                            </div>
                        </td>
                        <td>
                            <div class="sender-info">
                                <div class="sender-avatar" style="background: linear-gradient(45deg, #fa709a, #fee140);">DT</div>
                                <div class="sender-details">
                                    <div class="sender-name">DigitalTranscendence</div>
                                    <div class="sender-email">digital@nexus.soul</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline replied-btn" title="Already replied">
                                <i class="fas fa-check"></i> Replied
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-btn" title="Delete feedback">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            // Update mobile feedback cards
            const mobileFeedbackCards = document.getElementById('mobileFeedbackCards');
            if (mobileFeedbackCards) {
                mobileFeedbackCards.innerHTML = `
                    <div class="mobile-card feedback-unread">
                        <div class="card-header">
                            <div class="sender-info">
                                <div class="sender-avatar" style="background: linear-gradient(45deg, #667eea, #764ba2);">ES</div>
                                <div class="sender-details">
                                    <div class="sender-name">EternalSeeker</div>
                                    <div class="feedback-time">2 hours ago</div>
                                </div>
                            </div>
                            <span class="feedback-urgency normal">Normal</span>
                        </div>
                        <div class="card-content">
                            <div class="feedback-type">Feature Appreciation</div>
                            <div class="feedback-text">"The new mindmap feature is incredible! It's helped me visualize my spiritual journey in ways I never thought possible."</div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-primary">Reply</button>
                            <button class="btn btn-sm btn-danger">Delete</button>
                        </div>
                    </div>
                    <div class="mobile-card feedback-read">
                        <div class="card-header">
                            <div class="sender-info">
                                <div class="sender-avatar" style="background: linear-gradient(45deg, #f093fb, #f5576c);">MS</div>
                                <div class="sender-details">
                                    <div class="sender-name">MysticSoul</div>
                                    <div class="feedback-time">1 day ago</div>
                                </div>
                            </div>
                            <span class="feedback-urgency high">High Priority</span>
                        </div>
                        <div class="card-content">
                            <div class="feedback-type">Bug Report</div>
                            <div class="feedback-text">"I've been experiencing some issues with the comment system. Sometimes my comments don't appear immediately."</div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline replied-btn">Replied</button>
                            <button class="btn btn-sm btn-danger">Delete</button>
                        </div>
                    </div>
                `;
            }
        }
        
        function loadCurationData() {
            console.log('Loading curation data...');
            loadCurrentHighlights();
        }
        
        // Real API data loading functions
        async function loadRealDashboardData() {
            console.log('Loading real dashboard data from API...');
            
            try {
                const token = localStorage.getItem('sessionToken');
                const apiBaseUrl = window.NEXUS_CONFIG?.API_BASE_URL || 'https://nexus-ytrg.onrender.com/api';
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                // Load users data for dashboard stats
                const usersResponse = await fetch(`${apiBaseUrl}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    updateDashboardWithRealData(users);
                }
                
                // Load activity feed
                await loadRealActivityFeed();
                
            } catch (error) {
                console.error('Error loading real dashboard data:', error);
                // Fallback to sample data if API fails
                loadSampleDashboardData();
            }
        }
        
        function updateDashboardWithRealData(users) {
            // Calculate real metrics from user data
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const onlineUsers = users.filter(user => user.online).length;
            const dailyActiveUsers = users.filter(user => {
                const lastLogin = user.lastLogin ? new Date(user.lastLogin) : null;
                return lastLogin && lastLogin >= oneDayAgo;
            }).length;
            
            // Update dashboard elements
            const elements = {
                onlineUsers: document.getElementById('onlineUsers'),
                dailyActiveUsers: document.getElementById('dailyActiveUsers')
            };
            
            if (elements.onlineUsers) elements.onlineUsers.textContent = onlineUsers;
            if (elements.dailyActiveUsers) elements.dailyActiveUsers.textContent = dailyActiveUsers;
            
            console.log('Dashboard updated with real data:', { onlineUsers, dailyActiveUsers });
        }
        
        async function loadRealActivityFeed() {
            try {
                const token = localStorage.getItem('sessionToken');
                const apiBaseUrl = window.NEXUS_CONFIG?.API_BASE_URL || 'https://nexus-ytrg.onrender.com/api';
                
                // Load recent activity from multiple sources
                const [blogsRes, threadsRes, usersRes] = await Promise.all([
                    fetch(`${apiBaseUrl}/blogs?limit=5&sort=-createdAt`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${apiBaseUrl}/threads?limit=5&sort=-createdAt`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${apiBaseUrl}/users?limit=5&sort=-createdAt`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                const blogs = blogsRes.ok ? await blogsRes.json().catch(() => []) : [];
                const threads = threadsRes.ok ? await threadsRes.json().catch(() => []) : [];
                const users = usersRes.ok ? await usersRes.json().catch(() => []) : [];
                
                updateActivityFeedWithRealData(blogs, threads, users);
                
            } catch (error) {
                console.error('Error loading real activity feed:', error);
            }
        }
        
        function updateActivityFeedWithRealData(blogs, threads, users) {
            const activityFeed = document.getElementById('activityFeed');
            if (!activityFeed) return;
            
            const activities = [];
            
            // Add blog activities
            blogs.forEach(blog => {
                if (blog.author && blog.createdAt) {
                    activities.push({
                        type: 'blog_created',
                        message: `${blog.author.displayName || blog.author.username || 'A soul'} published "${blog.title || 'Untitled Soul Scroll'}"`,
                        timestamp: new Date(blog.createdAt),
                        icon: 'fas fa-scroll'
                    });
                }
            });
            
            // Add thread activities
            threads.forEach(thread => {
                if (thread.author && thread.createdAt) {
                    activities.push({
                        type: 'thread_created',
                        message: `${thread.author.displayName || thread.author.username || 'A soul'} started "${thread.title || 'Untitled Echo'}"`,
                        timestamp: new Date(thread.createdAt),
                        icon: 'fas fa-comments'
                    });
                }
            });
            
            // Add new user activities (only recent ones)
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            users.forEach(user => {
                if (user.createdAt && new Date(user.createdAt) > oneDayAgo) {
                    activities.push({
                        type: 'user_joined',
                        message: `${user.displayName || user.username} joined the eternal realm`,
                        timestamp: new Date(user.createdAt),
                        icon: 'fas fa-user-plus'
                    });
                }
            });
            
            // Sort by timestamp and take most recent 10
            activities.sort((a, b) => b.timestamp - a.timestamp);
            const recentActivities = activities.slice(0, 10);
            
            if (recentActivities.length === 0) {
                activityFeed.innerHTML = '<p class="no-activity">No recent activity</p>';
            } else {
                activityFeed.innerHTML = recentActivities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="${activity.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-message">${activity.message}</p>
                            <span class="activity-time">${formatTimeAgo(activity.timestamp)}</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        async function loadRealUsersData() {
            console.log('Loading real users data from API...');
            
            try {
                const token = localStorage.getItem('sessionToken');
                const apiBaseUrl = window.NEXUS_CONFIG?.API_BASE_URL || 'https://nexus-ytrg.onrender.com/api';
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch(`${apiBaseUrl}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    updateUsersTableWithRealData(users);
                } else {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Error loading real users data:', error);
                // Fallback to sample data if API fails
                loadSampleUsersData();
            }
        }
        
        function updateUsersTableWithRealData(users) {
            const usersTableBody = document.getElementById('usersTableBody');
            if (!usersTableBody) return;
            
            if (users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="7" class="no-data">No users found</td></tr>';
                return;
            }
            
            usersTableBody.innerHTML = users.slice(0, 20).map(user => {
                const initials = getInitials(user.displayName || user.username || 'U');
                const joinedDate = user.createdAt ? formatDate(new Date(user.createdAt)) : 'Unknown';
                const lastActiveDate = user.lastLogin ? formatTimeAgo(new Date(user.lastLogin)) : 'Never';
                const statusClass = user.online ? 'online' : 'offline';
                const statusText = user.online ? 'Online' : 'Offline';
                
                return `
                    <tr>
                        <td><div class="user-avatar" style="background: ${generateGradient(user.username || 'default')};">${initials}</div></td>
                        <td>${user.username || 'Unknown'}</td>
                        <td>${user.displayName || 'No display name'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${joinedDate}</td>
                        <td>${lastActiveDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" title="View Profile" onclick="viewUserProfile('${user._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" title="Send Message" onclick="sendUserMessage('${user._id}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log(`Users table updated with ${users.length} real users`);
        }
        
        async function loadRealAnalyticsData() {
            console.log('Loading real analytics data from API...');
            
            try {
                const token = localStorage.getItem('sessionToken');
                const apiBaseUrl = window.NEXUS_CONFIG?.API_BASE_URL || 'https://nexus-ytrg.onrender.com/api';
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                // Try to load from analytics endpoints
                const [usersRes, blogsRes, threadsRes] = await Promise.all([
                    fetch(`${apiBaseUrl}/users`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${apiBaseUrl}/blogs`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${apiBaseUrl}/threads`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                
                const users = usersRes.ok ? await usersRes.json().catch(() => []) : [];
                const blogs = blogsRes.ok ? await blogsRes.json().catch(() => []) : [];
                const threads = threadsRes.ok ? await threadsRes.json().catch(() => []) : [];
                
                updateAnalyticsWithRealData(users, blogs, threads);
                
            } catch (error) {
                console.error('Error loading real analytics data:', error);
                // Fallback to sample data if API fails
                loadSampleAnalyticsData();
            }
        }
        
        function updateAnalyticsWithRealData(users, blogs, threads) {
            // Calculate real analytics metrics
            const uniqueVisitors = users.length;
            const totalVisits = users.filter(u => u.lastLogin).length;
            const totalPages = blogs.length + threads.length;
            const totalHits = totalPages * 3; // Estimate
            
            const analyticsElements = {
                uniqueVisitors: document.getElementById('uniqueVisitors'),
                totalVisits: document.getElementById('totalVisits'),
                totalPages: document.getElementById('totalPages'),
                totalHits: document.getElementById('totalHits')
            };
            
            if (analyticsElements.uniqueVisitors) analyticsElements.uniqueVisitors.textContent = formatNumber(uniqueVisitors);
            if (analyticsElements.totalVisits) analyticsElements.totalVisits.textContent = formatNumber(totalVisits);
            if (analyticsElements.totalPages) analyticsElements.totalPages.textContent = formatNumber(totalPages);
            if (analyticsElements.totalHits) analyticsElements.totalHits.textContent = formatNumber(totalHits);
            
            console.log('Analytics updated with real data:', { uniqueVisitors, totalVisits, totalPages, totalHits });
        }
        
        async function loadRealFeedbackData() {
            console.log('Loading real feedback data from API...');
            
            try {
                const token = localStorage.getItem('sessionToken');
                const apiBaseUrl = window.NEXUS_CONFIG?.API_BASE_URL || 'https://nexus-ytrg.onrender.com/api';
                
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                // Since there might not be a specific feedback endpoint, we'll use sample data for now
                // But show a message indicating this would connect to real feedback API
                const feedbackTableBody = document.getElementById('feedbackTableBody');
                if (feedbackTableBody) {
                    feedbackTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="no-data">
                                <div style="text-align: center; padding: 2rem;">
                                    <i class="fas fa-database" style="font-size: 2rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                    <p>No feedback endpoint available yet</p>
                                    <small>Feedback system will connect to real API when endpoint is implemented</small>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                
                console.log('Feedback section prepared for real API integration');
                
            } catch (error) {
                console.error('Error loading real feedback data:', error);
                // Fallback to sample data if API fails
                loadSampleFeedbackData();
            }
        }
        
        // Utility functions
        function getInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
        }
        
        function generateGradient(seed) {
            const gradients = [
                'linear-gradient(45deg, #667eea, #764ba2)',
                'linear-gradient(45deg, #f093fb, #f5576c)',
                'linear-gradient(45deg, #4facfe, #00f2fe)',
                'linear-gradient(45deg, #fa709a, #fee140)',
                'linear-gradient(45deg, #a8edea, #fed6e3)',
                'linear-gradient(45deg, #ff9a9e, #fecfef)',
                'linear-gradient(45deg, #ffecd2, #fcb69f)',
                'linear-gradient(45deg, #a1c4fd, #c2e9fb)'
            ];
            const index = seed.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % gradients.length;
            return gradients[index];
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // User management action functions
        function viewUserProfile(userId) {
            console.log('Viewing profile for user:', userId);
            // This would open a modal or navigate to user profile
            alert(`Profile view for user ${userId} would be implemented here`);
        }
        
        function sendUserMessage(userId) {
            console.log('Sending message to user:', userId);
            // This would open the message modal
            alert(`Message compose for user ${userId} would be implemented here`);
        }
    </script>
</body>
</html> 